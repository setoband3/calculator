<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å·¥äº‹æ¨™ç¤ºæ¿ ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ„ãƒ¼ãƒ«</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }

:root {
  --blue:     #1d5fad;
  --blue2:    #0054a6;
  --ui-dark:  #1c2333;
  --ui-mid:   #2c3549;
  --ui-panel: #242d3f;
  --ui-border:#3a4560;
  --ui-hover: #334063;
  --ui-accent:#3b82f6;
  --ui-text:  #e8edf5;
  --ui-muted: #8896b0;
  --white:    #ffffff;
  --black:    #111111;
}

body {
  font-family:'Noto Sans JP',sans-serif;
  background:var(--ui-dark);
  color:var(--ui-text);
  height:100vh;
  overflow:hidden;
  user-select:none;
}

.app {
  display:grid;
  grid-template-rows:48px 1fr;
  grid-template-columns:var(--left-w,320px) 4px 1fr 4px var(--right-w,280px);
  height:100vh;
}

/* ãƒ‘ãƒãƒ«ãƒªã‚µã‚¤ã‚¶ãƒ¼ */
.resizer {
  background:var(--ui-border);
  cursor:col-resize;
  transition:background 0.15s;
  z-index:50;
}
.resizer:hover, .resizer.dragging { background:var(--ui-accent); }

/* TOP BAR */
.topbar {
  grid-column:1/-1;
  background:var(--ui-dark);
  border-bottom:1px solid var(--ui-border);
  display:flex; align-items:center;
  padding:0 14px; gap:8px; z-index:100;
}
.topbar-logo { font-size:13px; font-weight:900; color:var(--ui-accent); display:flex; align-items:center; gap:6px; margin-right:6px; }
.topbar-sep  { width:1px; height:24px; background:var(--ui-border); }
.tbtn {
  padding:5px 11px; border-radius:6px; border:1px solid var(--ui-border);
  background:var(--ui-panel); color:var(--ui-text); font-size:12px;
  font-family:'Noto Sans JP',sans-serif; cursor:pointer; transition:all 0.15s;
  display:flex; align-items:center; gap:4px; white-space:nowrap;
}
.tbtn:hover { background:var(--ui-hover); border-color:var(--ui-accent); }
.tbtn.primary { background:var(--ui-accent); border-color:var(--ui-accent); color:#fff; font-weight:700; }
.tbtn.primary:hover { background:#2563eb; }
.sz-pills { display:flex; align-items:center; gap:6px; margin-left:auto; font-size:11px; color:var(--ui-muted); }
.spill {
  padding:4px 10px; border-radius:20px; border:1px solid var(--ui-border);
  background:transparent; color:var(--ui-muted); font-size:11px;
  font-family:'Noto Sans JP',sans-serif; cursor:pointer; transition:all 0.15s;
}
.spill.active { border-color:var(--ui-accent); color:var(--ui-accent); background:rgba(59,130,246,0.1); }

/* LEFT PANEL */
.left-panel {
  background:var(--ui-panel); border-right:1px solid var(--ui-border);
  overflow-y:auto; padding:10px;
  display:flex; flex-direction:column; gap:9px;
}
.psec { font-size:10px; font-weight:700; color:var(--ui-muted); letter-spacing:2px; padding-bottom:4px; border-bottom:1px solid var(--ui-border); margin-bottom:2px; }
.fg  { display:flex; flex-direction:column; gap:3px; }
.fg label { font-size:11px; color:var(--ui-muted); }
.fg input, .fg textarea {
  padding:5px 8px; border:1px solid var(--ui-border); border-radius:5px;
  font-size:12px; font-family:'Noto Sans JP',sans-serif;
  color:var(--ui-text); background:var(--ui-mid);
  outline:none; transition:border-color 0.2s; resize:vertical;
}
.fg input:focus, .fg textarea:focus { border-color:var(--ui-accent); }
.fg textarea { min-height:46px; }
.fg .hint { font-size:10px; color:var(--ui-muted); }
.hsel { display:grid; grid-template-columns:1fr 1fr; gap:5px; }
.hbtn {
  padding:5px 3px; border:1px solid var(--ui-border); border-radius:5px;
  background:var(--ui-mid); cursor:pointer; text-align:center;
  font-size:11px; font-weight:500; font-family:'Noto Sans JP',sans-serif;
  line-height:1.4; transition:all 0.15s; color:var(--ui-text);
}
.hbtn.active { border-color:var(--ui-accent); background:rgba(59,130,246,0.15); color:var(--ui-accent); }
.togrow {
  display:flex; align-items:center; justify-content:space-between;
  padding:5px 8px; background:var(--ui-mid); border-radius:5px; border:1px solid var(--ui-border);
}
.togrow label { font-size:11px; color:var(--ui-muted); }
.tog { width:28px; height:16px; background:#444; border-radius:20px; cursor:pointer; position:relative; transition:background 0.2s; border:none; flex-shrink:0; }
.tog::after { content:''; width:12px; height:12px; background:#fff; border-radius:50%; position:absolute; top:2px; left:2px; transition:transform 0.2s; }
.tog.on { background:var(--ui-accent); }
.tog.on::after { transform:translateX(12px); }

/* CANVAS */
.canvas-area {
  background:#1a1a1a; overflow:hidden;
  display:flex; align-items:center; justify-content:center;
  position:relative; cursor:default;
  background-image:linear-gradient(rgba(255,255,255,0.02) 1px,transparent 1px),linear-gradient(90deg,rgba(255,255,255,0.02) 1px,transparent 1px);
  background-size:20px 20px;
}
.canvas-area.panning { cursor:grab; }
.canvas-area.panning:active { cursor:grabbing; }

/* ã‚ºãƒ¼ãƒ ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« */
.zoom-ctrl {
  position:absolute; bottom:12px; right:12px;
  display:flex; align-items:center; gap:4px; z-index:200;
  background:rgba(28,35,51,0.9); border:1px solid var(--ui-border);
  border-radius:8px; padding:4px 8px;
}
.zoom-btn {
  width:26px; height:26px; border-radius:5px;
  border:1px solid var(--ui-border); background:var(--ui-panel);
  color:var(--ui-text); font-size:16px; cursor:pointer;
  display:flex; align-items:center; justify-content:center;
  transition:all 0.15s; line-height:1;
}
.zoom-btn:hover { background:var(--ui-hover); border-color:var(--ui-accent); }
.zoom-label { font-size:11px; color:var(--ui-muted); min-width:38px; text-align:center; }

/* ã‚­ãƒ£ãƒ³ãƒã‚¹ãƒ©ãƒƒãƒ‘ãƒ¼ï¼ˆtransformç”¨ï¼‰ */
#canvasWrapper {
  position:absolute;
  transform-origin:0 0;
  will-change:transform;
}

#signCanvas {
  position:relative; flex-shrink:0;
  box-shadow:0 8px 60px rgba(0,0,0,0.7);
}

/* SVG background */
#svgBg {
  position:absolute; inset:0;
  width:100%; height:100%;
  pointer-events:none;
  z-index:0;
}

/* Text blocks */
.tblock {
  position:absolute; cursor:move;
  border:1.5px solid transparent; border-radius:2px;
  transition:border-color 0.1s;
  z-index:10; white-space:pre-wrap; word-break:break-all;
  line-height:1.2;
}
.tblock:hover { border-color:rgba(59,130,246,0.5); }
.tblock.selected { border-color:var(--ui-accent) !important; z-index:50; }
.tblock.selected::after {
  content:''; position:absolute; inset:-5px;
  border:1px dashed rgba(59,130,246,0.4); border-radius:3px; pointer-events:none;
}
.rhandle {
  display:none; position:absolute; bottom:-5px; right:-5px;
  width:10px; height:10px; background:var(--ui-accent); border-radius:50%;
  cursor:se-resize; z-index:60;
}
.tblock.selected .rhandle { display:block; }

/* RIGHT PANEL */
.right-panel {
  background:var(--ui-panel); border-left:1px solid var(--ui-border);
  overflow-y:auto; padding:10px;
  display:flex; flex-direction:column; gap:8px;
}
.prop-empty { color:var(--ui-muted); font-size:12px; text-align:center; padding:20px 0; line-height:1.8; }
.slrow { display:flex; align-items:center; gap:6px; }
.slrow label { font-size:11px; color:var(--ui-muted); min-width:48px; }
.slrow input[type=range] { flex:1; accent-color:var(--ui-accent); }
.slrow .val { font-size:11px; color:var(--ui-accent); min-width:26px; text-align:right; }
.crow { display:flex; align-items:center; gap:5px; flex-wrap:wrap; }
.csw { width:20px; height:20px; border-radius:50%; border:2px solid transparent; cursor:pointer; transition:border-color 0.15s; flex-shrink:0; }
.csw.active { border-color:var(--ui-accent); }
.arow, .wrow { display:flex; gap:3px; }
.abtn, .wbtn {
  flex:1; padding:4px; border:1px solid var(--ui-border); border-radius:4px;
  background:var(--ui-mid); color:var(--ui-muted);
  font-size:12px; cursor:pointer; text-align:center; transition:all 0.15s;
  font-family:'Noto Sans JP',sans-serif;
}
.abtn.active, .abtn:hover,
.wbtn.active, .wbtn:hover { border-color:var(--ui-accent); color:var(--ui-accent); background:rgba(59,130,246,0.1); }
.dbtn {
  width:100%; padding:7px; border:1px solid #e53e3e; border-radius:5px;
  background:transparent; color:#e53e3e; font-size:12px;
  font-family:'Noto Sans JP',sans-serif; cursor:pointer; transition:all 0.15s; margin-top:4px;
}
.dbtn:hover { background:#e53e3e; color:#fff; }
.pos-tt {
  position:absolute; background:rgba(0,0,0,0.8); color:#fff;
  font-size:10px; padding:2px 6px; border-radius:3px;
  pointer-events:none; z-index:300; display:none; white-space:nowrap;
}
/* ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ */
.toast {
  position:fixed; bottom:24px; left:50%; transform:translateX(-50%);
  background:#1e293b; color:#e8edf5; font-size:13px;
  padding:10px 20px; border-radius:8px; border:1px solid var(--ui-accent);
  box-shadow:0 4px 20px rgba(0,0,0,0.4);
  z-index:9999; pointer-events:none;
  opacity:0; transition:opacity 0.3s;
  white-space:nowrap;
}
.toast.show { opacity:1; }
/* è‡ªå‹•ä¿å­˜ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ */
.autosave-dot {
  width:7px; height:7px; border-radius:50%; background:#22c55e;
  display:inline-block; margin-right:4px;
  animation:pulse 2s infinite;
}
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }
</style>
</head>
<body>
<div class="app">

<!-- TOP BAR -->
<div class="topbar">
  <div class="topbar-logo">ğŸš§ çœ‹æ¿ãƒ‡ã‚¶ã‚¤ãƒŠãƒ¼</div>
  <div class="topbar-sep"></div>
  <button class="tbtn" onclick="resetLayout()">â†º ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå†èª­è¾¼</button>
  <button class="tbtn" onclick="addFreeBlock()">ï¼‹ ãƒ†ã‚­ã‚¹ãƒˆè¿½åŠ </button>
  <div class="topbar-sep"></div>
  <div class="topbar-sep"></div>
  <button class="tbtn" onclick="saveToLocal()" id="btnSave">ğŸ’¾ ä¿å­˜</button>
  <button class="tbtn" onclick="exportJSON()">ğŸ“¤ JSONã§æ›¸ãå‡ºã—</button>
  <label class="tbtn" style="cursor:pointer;">ğŸ“‚ JSONèª­è¾¼<input type="file" accept=".json" onchange="importJSON(event)" style="display:none;"></label>
  <div class="topbar-sep"></div>
  <button class="tbtn primary" onclick="exportSVG()">ğŸ“ SVGå‡ºåŠ›</button>
  <div class="sz-pills">
    <span>ã‚µã‚¤ã‚ºï¼š</span>
    <button class="spill active" id="sz-large" onclick="setSize('large')">å¤§ 1100Ã—1400</button>
    <button class="spill" id="sz-small" onclick="setSize('small')">å° 800Ã—900</button>
  </div>
</div>

<!-- LEFT PANEL -->
<div class="left-panel" id="leftPanel">
  <div><div class="psec">ãƒ˜ãƒƒãƒ€ãƒ¼æ–‡è¨€</div>
    <div class="hsel">
      <button class="hbtn active" id="hb-mei" onclick="setHeader('meiwaku')">ã”è¿·æƒ‘ã‚’<br>ãŠã‹ã‘ã—ã¾ã™</button>
      <button class="hbtn" id="hb-kyo" onclick="setHeader('kyoryoku')">ã”å”åŠ›ã‚’<br>ãŠé¡˜ã„ã—ã¾ã™</button>
    </div>
  </div>

  <div><div class="psec">å·¥äº‹å†…å®¹ã®è¦ç´„</div>
    <div class="fg">
      <textarea id="f-main" oninput="updateKey('main')" rows="3">å£Šã‚ŒãŸè­·å²¸ã‚’
ç›´ã—ã¦ã„ã¾ã™ã€‚</textarea>
      <span class="hint">æ–‡å­—æ•°ã§è‡ªå‹•ã‚µã‚¤ã‚ºèª¿æ•´</span>
    </div>
  </div>

  <div><div class="psec">å·¥äº‹å ´æ‰€ï¼ˆä»»æ„ï¼‰</div>
    <div class="togrow"><label>å·¥äº‹å ´æ‰€ã‚’è¡¨ç¤º</label><button class="tog" id="locTog" onclick="toggleLoc()"></button></div>
    <div id="locField" style="display:none;margin-top:5px;">
      <div class="fg"><input type="text" id="f-loc" placeholder="ä¾‹ï¼šæ—¥ç”°å¸‚å¤§å­—å°é‡å­—ä¸­å±±åœ°å†…" oninput="updateKey('loc')"></div>
    </div>
  </div>

  <div><div class="psec">å·¥æœŸãƒ»æ™‚é–“å¸¯</div>
    <div class="fg"><label>å·¥æœŸ</label><input type="text" id="f-pdate" value="ä»¤å’Œï¼—å¹´ï¼’æœˆ28æ—¥ã¾ã§" oninput="updateKey('pdate')"></div>
    <div class="fg" style="margin-top:4px;"><label>æ™‚é–“å¸¯</label><input type="text" id="f-ptime" value="8:00 ï½ 17:00" oninput="updateKey('ptime')"></div>
  </div>

  <div><div class="psec">å·¥äº‹å</div>
    <div class="fg"><input type="text" id="f-proj" value="èŠ±æœˆå·ä¸‰å’Œåœ°åŒºå¤–ç½å®³å¾©æ—§å·¥äº‹" oninput="updateKey('proj')"></div>
  </div>

  <div><div class="psec">ç™ºæ³¨è€…</div>
    <div class="fg"><textarea id="f-client" rows="3" oninput="updateKey('client')">å›½åœŸäº¤é€šçœã€€ä¹å·åœ°æ–¹æ•´å‚™å±€
ç­‘å¾Œå·æ²³å·äº‹å‹™æ‰€ã€€æ—¥ç”°å‡ºå¼µæ‰€
é›»è©±ã€€0972ï¼23ï¼5291</textarea></div>
  </div>

  <div><div class="psec">æ–½å·¥è€…</div>
    <div class="fg"><textarea id="f-cont" rows="3" oninput="updateKey('cont')">ç”°ä¸­å»ºè¨­æ ªå¼ä¼šç¤¾
é›»è©±ã€€0973ï¼23ï¼8185
ç¾å ´ä»£ç†äººã€€å±±æœ¬ã€€äº®ä¸€</textarea></div>
  </div>
</div>

<!-- LEFT RESIZER -->
<div class="resizer" id="resizerLeft"></div>

<!-- CANVAS -->
<div class="canvas-area" id="canvasArea">
  <div id="canvasWrapper">
    <div id="signCanvas">
      <div id="svgBgWrap"></div>
    </div>
  </div>
  <div class="pos-tt" id="posTT"></div>
  <!-- ã‚ºãƒ¼ãƒ ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
  <div class="zoom-ctrl">
    <button class="zoom-btn" onclick="zoomBy(-0.1)">ï¼</button>
    <span class="zoom-label" id="zoomLabel">100%</span>
    <button class="zoom-btn" onclick="zoomBy(+0.1)">ï¼‹</button>
    <button class="zoom-btn" onclick="zoomFit()" title="å…¨ä½“è¡¨ç¤º" style="font-size:12px;width:auto;padding:0 6px;">åˆã‚ã›ã‚‹</button>
  </div>
</div>

<!-- RIGHT RESIZER -->
<div class="resizer" id="resizerRight"></div>

<!-- RIGHT PANEL -->
<div class="right-panel" id="rightPanel">
  <div class="psec">ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£</div>
  <div class="prop-empty" id="propEmpty">â† ãƒ†ã‚­ã‚¹ãƒˆã‚’<br>ã‚¯ãƒªãƒƒã‚¯ã—ã¦<br>é¸æŠã—ã¦ãã ã•ã„</div>
  <div id="propCtrl" style="display:none;">
    <div class="psec">ãƒ†ã‚­ã‚¹ãƒˆ</div>
    <div class="fg"><textarea id="p-text" rows="3" oninput="applyPropText()"></textarea></div>

    <div class="psec" style="margin-top:7px;">ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º</div>
    <div class="slrow">
      <label>ã‚µã‚¤ã‚º</label>
      <input type="range" id="p-fs" min="6" max="150" step="0.5" oninput="applyPropFS()">
      <span class="val" id="p-fs-v">32</span>
    </div>

    <div class="psec" style="margin-top:7px;">å¤ªã•</div>
    <div class="wrow">
      <button class="wbtn" id="wb-400" onclick="applyWeight(400)">æ¨™æº–</button>
      <button class="wbtn" id="wb-700" onclick="applyWeight(700)">å¤ªå­—</button>
      <button class="wbtn active" id="wb-900" onclick="applyWeight(900)">æ¥µå¤ª</button>
    </div>

    <div class="psec" style="margin-top:7px;">æ–‡å­—è‰²</div>
    <div class="crow">
      <div class="csw active" style="background:#111" data-c="#111111" onclick="applyColor(this)"></div>
      <div class="csw" style="background:#fff;outline:1px solid #555" data-c="#ffffff" onclick="applyColor(this)"></div>
      <div class="csw" style="background:#1d5fad" data-c="#1d5fad" onclick="applyColor(this)"></div>
      <div class="csw" style="background:#e74c3c" data-c="#e74c3c" onclick="applyColor(this)"></div>
      <input type="color" id="p-color" value="#111111" oninput="applyColorHex(this.value)" style="width:20px;height:20px;border:none;background:none;cursor:pointer;padding:0;border-radius:50%;">
    </div>

    <div class="psec" style="margin-top:7px;">è¡Œé–“</div>
    <div class="slrow">
      <label>è¡Œé–“</label>
      <input type="range" id="p-lh" min="0.9" max="2.5" step="0.05" value="1.2" oninput="applyPropLH()">
      <span class="val" id="p-lh-v">1.20</span>
    </div>

    <div class="psec" style="margin-top:7px;">æ–‡å­—é–“éš”</div>
    <div class="slrow">
      <label>å­—é–“</label>
      <input type="range" id="p-ls" min="-5" max="30" step="0.5" value="0" oninput="applyPropLS()">
      <span class="val" id="p-ls-v">0</span>
    </div>

    <div class="psec" style="margin-top:7px;">æ–‡å­—æƒãˆ</div>
    <div class="arow">
      <button class="abtn active" id="ab-left"   onclick="applyAlign('left')">â‰¡</button>
      <button class="abtn"        id="ab-center" onclick="applyAlign('center')">â˜°</button>
      <button class="abtn"        id="ab-right"  onclick="applyAlign('right')">â‰£</button>
    </div>

    <div class="psec" style="margin-top:7px;">ä½ç½®ãƒ»å¹… (px)</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:5px;">
      <div class="fg"><label>X</label><input type="number" id="p-x" oninput="applyPropPos()"></div>
      <div class="fg"><label>Y</label><input type="number" id="p-y" oninput="applyPropPos()"></div>
      <div class="fg"><label>å¹…</label><input type="number" id="p-w" oninput="applyPropW()"></div>
    </div>

    <button class="dbtn" onclick="deleteSelected()">ğŸ—‘ å‰Šé™¤</button>
  </div>
</div>

</div><!-- .app -->

<div class="toast" id="toast"></div>

<script>
// ============================================================
//  SVG èƒŒæ™¯ãƒ‡ãƒ¼ã‚¿ï¼ˆå®Ÿãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³åŸ‹ã‚è¾¼ã¿ï¼‰
// ============================================================
const SVG_LARGE = `<svg id="_ãƒ¬ã‚¤ãƒ¤ãƒ¼_1" xmlns="http://www.w3.org/2000/svg" version="1.1" viewBox="0 0 1190.55 841.89">
  <defs><style>.st0{fill:#0054a6;}.st1{fill:none;stroke:#231f20;}</style></defs>
  <rect class="st1" x="117.45" y="155.92" width="311.81" height="396.85"/>
  <path class="st0" d="M121.62,160.09v388.51h303.47V160.09H121.62ZM422.1,545.6H124.62V212.02h297.47v333.58h.01Z"/>
  <path class="st0" d="M128.16,337.04v69.88h290.4v-69.88H128.16ZM415.56,340.04v63.88H131.16v-63.88h284.4Z"/>
  <path class="st0" d="M402.54,411.06H144.17c-8.84,0-16.02,6.67-16.02,14.9s7.17,14.9,16.02,14.9h258.37c8.84,0,16.02-6.67,16.02-14.9s-7.17-14.9-16.02-14.9h0Z"/>
</svg>`;

const SVG_SMALL = `<svg id="_ãƒ¬ã‚¤ãƒ¤ãƒ¼_1" data-name="ãƒ¬ã‚¤ãƒ¤ãƒ¼_1" xmlns="http://www.w3.org/2000/svg" version="1.1" viewBox="0 0 1190.55 841.89">
  <defs><style>.st0{fill:#0054a6;}.st1{stroke:#231f20;}.st1,.st2{fill:none;}.st2{stroke:#1d5fad;stroke-miterlimit:10;stroke-width:1.6px;}.st3{fill:#1d5fad;}</style></defs>
  <rect class="st3" x="152.75" y="177.05" width="215.84" height="28.85"/>
  <rect class="st1" x="147.28" y="171.99" width="226.77" height="255.12"/>
  <path class="st0" d="M369.67,423.14h-218v-247.17h218v247.17ZM153.83,420.98h213.68v-242.85h-213.68v242.85Z"/>
  <rect class="st2" x="158.52" y="284.4" width="204.03" height="41.36"/>
  <path class="st3" d="M355.14,328.14s0,0,0,0h-188.33s0,0,0,0c-4.57,0-8.27,3.9-8.27,8.72s3.7,8.72,8.27,8.72h188.34c4.57,0,8.27-3.9,8.27-8.72s-3.7-8.72-8.27-8.72Z"/>
</svg>`;

// ============================================================
//  SVGã®åº§æ¨™ç³»ï¼šviewBox = 0 0 1190.55 841.89 (æ¨ªå‘ãA3)
//  çœ‹æ¿ã®æ åº§æ¨™ï¼ˆå¤§ãƒ»å°ãã‚Œãã‚Œï¼‰
// ============================================================
const VB = { w: 1190.55, h: 841.89 }; // viewBox

// å¤§ã‚µã‚¤ã‚ºçœ‹æ¿ã®å„ã‚¨ãƒªã‚¢åº§æ¨™ï¼ˆviewBoxåº§æ¨™ï¼‰
const ZONES_LARGE = {
  outerBox: { x:117.45, y:155.92, w:311.81, h:396.85 },
  // å†…å´æœ‰åŠ¹ã‚¨ãƒªã‚¢ï¼ˆå¤–æ ã‹ã‚‰ç½«ç·šåˆ†å†…å´ï¼‰
  inner:    { x:124.62, y:160.09, w:297.47, h:385.51 },
  // ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆé’å¸¯ï¼‰= innerã®topã€œ212.02
  header:   { x:124.62, y:160.09, w:297.47, h:51.93 },
  // ãƒ¡ã‚¤ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ = 212.02ã€œ337.04
  main:     { x:124.62, y:212.02, w:297.47, h:125.02 },
  // å·¥æœŸæ  = 337.04ã€œ406.92
  period:   { x:128.16, y:337.04, w:290.40, h:69.88  },
  // å·¥äº‹åå¸¯ï¼ˆpillï¼‰= 411.06ã€œ440.86
  projBand: { x:128.16, y:411.06, w:290.40, h:29.80  },
  // ç™ºæ³¨è€…ãƒ»æ–½å·¥è€…ã‚¨ãƒªã‚¢ = 440.86ã€œ545.60
  info:     { x:124.62, y:440.86, w:297.47, h:104.74 },
};

// å°ã‚µã‚¤ã‚ºçœ‹æ¿ã®å„ã‚¨ãƒªã‚¢åº§æ¨™ï¼ˆviewBoxåº§æ¨™ï¼‰
const ZONES_SMALL = {
  outerBox: { x:147.28, y:171.99, w:226.77, h:255.12 },
  inner:    { x:153.83, y:177.05, w:213.68, h:246.09 },
  // ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆé’å¸¯ï¼‰ = 177.05ã€œ205.90
  header:   { x:153.83, y:177.05, w:213.68, h:28.85  },
  // ãƒ¡ã‚¤ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ = 205.90ã€œ284.40
  main:     { x:153.83, y:205.90, w:213.68, h:78.50  },
  // å·¥æœŸæ ï¼ˆé’ç·šæ ï¼‰ = 284.40ã€œ325.76
  period:   { x:158.52, y:284.40, w:204.03, h:41.36  },
  // å·¥äº‹åå¸¯ï¼ˆpillï¼‰ = 328.14ã€œ345.58
  projBand: { x:158.52, y:328.14, w:195.01, h:17.44  },
  // ç™ºæ³¨è€…ãƒ»æ–½å·¥è€… = 345.58ã€œ423.14
  info:     { x:153.83, y:345.58, w:213.68, h:77.56  },
};

// ============================================================
//  STATE
// ============================================================
let sz       = 'large';
let showLoc  = false;
let scale    = 1;       // canvasã®px/viewBoxå˜ä½
let blocks   = [];
let selectedId = null;
let dragState  = null;
let resizeState = null;
let idCnt = 0;

// ã‚ºãƒ¼ãƒ ãƒ»ãƒ‘ãƒ³
let zoomLevel = 1.0;
let panX = 0, panY = 0;
let isPanning = false;
let panStart = null;
let spaceDown = false;

const canvasEl = document.getElementById('signCanvas');
const bgWrap   = document.getElementById('svgBgWrap');

// ============================================================
//  ã‚¹ã‚±ãƒ¼ãƒ«è¨ˆç®—
// ============================================================
function calcScale() {
  const area = document.getElementById('canvasArea');
  const mW = area.clientWidth  - 40;
  const mH = area.clientHeight - 40;
  const s = Math.min(mW / VB.w, mH / VB.h);
  return Math.max(s, 0.15);
}

function vb2px(v) { return v * scale * zoomLevel; }
function px2vb(p) { return p / (scale * zoomLevel); }

// ============================================================
//  ZOOM & PAN
// ============================================================
function applyTransform() {
  const area    = document.getElementById('canvasArea');
  const wrapEl  = document.getElementById('canvasWrapper');
  // ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ã¦canvasè‡ªä½“ã®ã‚µã‚¤ã‚ºã‚’å¤‰ãˆã‚‹ï¼ˆã‚·ãƒ£ãƒ¼ãƒ—è¡¨ç¤ºï¼‰
  const effectiveScale = scale * zoomLevel;
  const cW = Math.round(VB.w * effectiveScale);
  const cH = Math.round(VB.h * effectiveScale);
  canvasEl.style.width  = cW + 'px';
  canvasEl.style.height = cH + 'px';

  const aW = area.clientWidth;
  const aH = area.clientHeight;
  const baseX = (aW - cW) / 2;
  const baseY = (aH - cH) / 2;

  wrapEl.style.transform = `translate(${baseX + panX}px, ${baseY + panY}px)`;
  wrapEl.style.transformOrigin = '0 0';

  // ãƒ–ãƒ­ãƒƒã‚¯ã®è¡¨ç¤ºã‚µã‚¤ã‚ºã‚‚å†è¨ˆç®—
  blocks.forEach(b => renderBlock(b));

  document.getElementById('zoomLabel').textContent = Math.round(zoomLevel * 100) + '%';
}

function zoomBy(delta, cx, cy) {
  const newZoom = Math.max(0.2, Math.min(8, zoomLevel + delta));
  if (cx !== undefined) {
    const ratio = newZoom / zoomLevel;
    panX = cx - ratio * (cx - panX);
    panY = cy - ratio * (cy - panY);
  }
  zoomLevel = newZoom;
  applyTransform();
}

function zoomFit() {
  panX = 0; panY = 0; zoomLevel = 1.0;
  applyTransform();
}

// ãƒã‚¦ã‚¹ãƒ›ã‚¤ãƒ¼ãƒ«ã§ã‚ºãƒ¼ãƒ ï¼ˆã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã‚’ä¸­å¿ƒã«ï¼‰
document.getElementById('canvasArea').addEventListener('wheel', e => {
  e.preventDefault();
  const area   = document.getElementById('canvasArea');
  const rect   = area.getBoundingClientRect();

  // ã‚«ãƒ¼ã‚½ãƒ«ã®canvasAreaå†…åº§æ¨™
  const mouseX = e.clientX - rect.left;
  const mouseY = e.clientY - rect.top;

  const delta    = e.deltaY < 0 ? 0.12 : -0.12;
  const newZoom  = Math.max(0.2, Math.min(8, zoomLevel + delta));
  const ratio    = newZoom / zoomLevel;

  // ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã‚’å›ºå®šã—ãŸã¾ã¾panã‚’èª¿æ•´
  panX = mouseX - ratio * (mouseX - panX);
  panY = mouseY - ratio * (mouseY - panY);

  zoomLevel = newZoom;
  applyTransform();
}, { passive: false });

// ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼ï¼‹ãƒ‰ãƒ©ãƒƒã‚°ã§ãƒ‘ãƒ³
document.addEventListener('keydown', e => {
  if (e.code === 'Space' && !e.target.matches('input,textarea')) {
    spaceDown = true;
    document.getElementById('canvasArea').classList.add('panning');
    e.preventDefault();
  }
});
document.addEventListener('keyup', e => {
  if (e.code === 'Space') {
    spaceDown = false;
    isPanning = false;
    document.getElementById('canvasArea').classList.remove('panning');
  }
});

document.getElementById('canvasArea').addEventListener('mousedown', e => {
  if (spaceDown || e.button === 1) {
    isPanning = true;
    panStart  = { x: e.clientX - panX, y: e.clientY - panY };
    e.preventDefault();
  }
});

document.addEventListener('mousemove', e => {
  if (isPanning && panStart) {
    panX = e.clientX - panStart.x;
    panY = e.clientY - panStart.y;
    applyTransform();
  }
});

document.addEventListener('mouseup', e => {
  if (e.button === 1 || isPanning) {
    isPanning = false;
    panStart  = null;
  }
});

// ============================================================
//  ãƒ‘ãƒãƒ«ãƒªã‚µã‚¤ã‚º
// ============================================================
(function() {
  const app = document.querySelector('.app');

  // å·¦ãƒ‘ãƒãƒ«
  const rL = document.getElementById('resizerLeft');
  let draggingL = false;
  rL.addEventListener('mousedown', e => { draggingL = true; rL.classList.add('dragging'); e.preventDefault(); });
  document.addEventListener('mousemove', e => {
    if (!draggingL) return;
    const newW = Math.max(200, Math.min(500, e.clientX));
    app.style.setProperty('--left-w', newW + 'px');
  });
  document.addEventListener('mouseup', () => { draggingL = false; rL.classList.remove('dragging'); });

  // å³ãƒ‘ãƒãƒ«
  const rR = document.getElementById('resizerRight');
  let draggingR = false;
  rR.addEventListener('mousedown', e => { draggingR = true; rR.classList.add('dragging'); e.preventDefault(); });
  document.addEventListener('mousemove', e => {
    if (!draggingR) return;
    const newW = Math.max(200, Math.min(500, window.innerWidth - e.clientX));
    app.style.setProperty('--right-w', newW + 'px');
  });
  document.addEventListener('mouseup', () => { draggingR = false; rR.classList.remove('dragging'); });
})();

// ============================================================
//  CANVAS SETUP
// ============================================================
function setupCanvas() {
  scale = calcScale();

  // SVGèƒŒæ™¯ï¼ˆã‚µã‚¤ã‚ºã¯applyTransformãŒç®¡ç†ï¼‰
  bgWrap.innerHTML = sz === 'large' ? SVG_LARGE : SVG_SMALL;
  const svgEl = bgWrap.querySelector('svg');
  svgEl.style.cssText = `position:absolute;inset:0;width:100%;height:100%;pointer-events:none;z-index:0;`;

  canvasEl.style.background = '#fff';
  applyTransform();
}

// ============================================================
//  ç¾åœ¨ã®ZONESå–å¾—
// ============================================================
function Z() { return sz === 'large' ? ZONES_LARGE : ZONES_SMALL; }

// ============================================================
//  ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ–ãƒ­ãƒƒã‚¯ç”Ÿæˆ
// ============================================================
function buildTemplate() {
  blocks = [];
  canvasEl.querySelectorAll('.tblock').forEach(el => el.remove());
  selectedId = null;

  const z = Z();

  // ---- ã‚¹ã‚±ãƒ¼ãƒ«ä¿‚æ•°ï¼ˆ1100åŸºæº–ã®å®Ÿæ¸¬å€¤ã‚’ä»–ã‚µã‚¤ã‚ºã«æ¯”ä¾‹è¨ˆç®—ï¼‰----
  // å¤§ã‚µã‚¤ã‚º(1100)ã®innerå¹…=297.47 ã‚’åŸºæº–ã«ã‚¹ã‚±ãƒ¼ãƒ«
  const BASE_W = ZONES_LARGE.inner.w; // 297.47
  const sc = z.inner.w / BASE_W;      // å°ã‚µã‚¤ã‚ºãªã‚‰ â‰’ 0.719

  // ---- ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ†ã‚­ã‚¹ãƒˆ ----
  const hdrText = document.getElementById('hb-mei').classList.contains('active')
    ? 'ã”è¿·æƒ‘ã‚’ãŠã‹ã‘ã—ã¾ã™' : 'ã”å”åŠ›ã‚’ãŠé¡˜ã„ã—ã¾ã™';
  mkBlock({
    key:'header', text: hdrText,
    x: z.header.x + z.header.h * 1.2,
    y: z.header.y + z.header.h * 0.18,
    w: z.header.w - z.header.h * 1.2 - 4,
    fs: 25 * sc, fw: 700, color:'#ffffff', align:'left', lh:1.0,
  });

  // ---- ãƒ¡ã‚¤ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼ˆæ–‡å­—æ•°ã§è‡ªå‹•ã‚µã‚¤ã‚ºèª¿æ•´ï¼‰----
  const mainRaw   = document.getElementById('f-main').value;
  const mainLines = mainRaw.split('\n').filter(l => l.trim().length > 0);
  const nL    = Math.max(mainLines.length, 1);
  const maxCh = Math.max(...mainLines.map(l => l.length), 1);
  const avH   = z.main.h * 0.92;
  const avW   = z.main.w * 0.94;
  let mFS = avH / (nL * 1.18);
  const mFSw = avW / (maxCh * 0.95);
  mFS = Math.min(mFS, mFSw, z.main.w * 0.18);
  mFS = Math.max(mFS, 8);
  const mTH   = nL * mFS * 1.18;
  const mTopY = z.main.y + (z.main.h - mTH) / 2;
  mkBlock({
    key:'main', text: mainRaw,
    x: z.main.x + z.main.w * 0.03,
    y: mTopY,
    w: z.main.w * 0.94,
    fs: mFS, fw: 900, color:'#111111', align:'center', lh:1.18,
  });

  // ---- å·¥äº‹å ´æ‰€ï¼ˆä»»æ„ï¼‰ ----
  if (showLoc) {
    mkBlock({
      key:'loc', text: document.getElementById('f-loc').value || 'å·¥äº‹å ´æ‰€',
      x: z.main.x + 4,
      y: z.main.y + z.main.h + 2,
      w: z.main.w - 8,
      fs: 10 * sc, fw: 400, color:'#333333', align:'left', lh:1.0,
    });
  }

  // ---- å·¥æœŸï¼ˆæ—¥ä»˜ï¼‰ ----
  mkBlock({
    key:'pdate', text: document.getElementById('f-pdate').value,
    x: z.period.x + z.period.w * 0.03,
    y: z.period.y + z.period.h * 0.15,
    w: z.period.w * 0.94,
    fs: 25 * sc, fw: 900, color:'#111111', align:'center', lh:1.1,
  });

  // ---- å·¥æœŸï¼ˆæ™‚é–“å¸¯ï¼‰ ----
  mkBlock({
    key:'ptime', text: 'æ™‚é–“å¸¯ã€€' + document.getElementById('f-ptime').value,
    x: z.period.x + z.period.w * 0.03,
    y: z.period.y + z.period.h * 0.58,
    w: z.period.w * 0.94,
    fs: 23 * sc, fw: 700, color:'#111111', align:'center', lh:1.0,
  });

  // ---- å·¥äº‹å ----
  mkBlock({
    key:'proj', text: document.getElementById('f-proj').value,
    x: z.projBand.x + 8,
    y: z.projBand.y + (z.projBand.h - 18 * sc) / 2,
    w: z.projBand.w - 16,
    fs: 18 * sc, fw: 700, color:'#ffffff', align:'center', lh:1.0,
  });

  // ---- ç™ºæ³¨è€…ãƒ»æ–½å·¥è€… ----
  const inFS  = 12 * sc;
  const inLH  = 1.25;
  const lblW  = z.info.w * 0.175;
  const valX  = z.info.x + lblW + z.info.w * 0.02;
  const valW  = z.info.w - lblW - z.info.w * 0.04;

  const cliLines = document.getElementById('f-client').value.split('\n');
  const cliTopY  = z.info.y + z.info.h * 0.06;
  const cliH     = cliLines.length * inFS * inLH;
  const conTopY  = cliTopY + cliH + z.info.h * 0.08;

  mkBlock({
    key:'cli-lbl', text:'ç™ºæ³¨è€…',
    x: z.info.x + 4, y: cliTopY,
    w: lblW, fs: inFS, fw: 900, color:'#111111', align:'left', lh:1.0,
  });
  mkBlock({
    key:'cli-val', text: document.getElementById('f-client').value,
    x: valX, y: cliTopY,
    w: valW, fs: inFS, fw: 900, color:'#111111', align:'left', lh: inLH,
  });
  mkBlock({
    key:'con-lbl', text:'æ–½å·¥è€…',
    x: z.info.x + 4, y: conTopY,
    w: lblW, fs: inFS, fw: 900, color:'#111111', align:'left', lh:1.0,
  });
  mkBlock({
    key:'con-val', text: document.getElementById('f-cont').value,
    x: valX, y: conTopY,
    w: valW, fs: inFS, fw: 900, color:'#111111', align:'left', lh: inLH,
  });

  renderAll();
  updatePropPanel();
}

// ============================================================
//  ãƒ–ãƒ­ãƒƒã‚¯ç”Ÿæˆãƒ»æç”»
// ============================================================
function mkBlock(opts) {
  const b = {
    id: ++idCnt,
    key:    opts.key   || null,
    text:   opts.text  || '',
    x:      opts.x     || 0,
    y:      opts.y     || 0,
    w:      opts.w     || 100,
    fs:     opts.fs    || 16,
    fw:     opts.fw    || 700,
    color:  opts.color || '#111111',
    align:  opts.align || 'left',
    lh:     opts.lh    || 1.2,
    ls:     opts.ls    || 0,
  };
  blocks.push(b);
  return b;
}

function getB(id) { return blocks.find(b => b.id === id); }

function renderBlock(b) {
  let el = canvasEl.querySelector(`[data-id="${b.id}"]`);
  if (!el) {
    el = document.createElement('div');
    el.className = 'tblock';
    el.dataset.id = b.id;
    const rh = document.createElement('div');
    rh.className = 'rhandle';
    el.appendChild(rh);
    rh.addEventListener('mousedown', e => { e.stopPropagation(); startResize(e, b.id); });
    el.addEventListener('mousedown', e => { if (e.target === rh) return; startDrag(e, b.id); });
    el.addEventListener('click', e => { e.stopPropagation(); selectBlock(b.id); });
    canvasEl.appendChild(el);
  }

  el.style.left          = vb2px(b.x) + 'px';
  el.style.top           = vb2px(b.y) + 'px';
  el.style.width         = vb2px(b.w) + 'px';
  el.style.fontSize      = vb2px(b.fs) + 'px';
  el.style.fontWeight    = b.fw;
  el.style.color         = b.color;
  el.style.textAlign     = b.align;
  el.style.lineHeight    = b.lh;
  el.style.letterSpacing = vb2px(b.ls || 0) + 'px';
  el.style.zIndex        = b.id === selectedId ? 50 : 10;
  el.classList.toggle('selected', b.id === selectedId);

  // ãƒ†ã‚­ã‚¹ãƒˆæ›´æ–°
  const rh = el.querySelector('.rhandle');
  Array.from(el.childNodes).forEach(n => { if (n !== rh) n.remove(); });
  el.insertBefore(document.createTextNode(b.text), rh);
}

function renderAll() {
  canvasEl.querySelectorAll('.tblock').forEach(el => {
    if (!blocks.find(b => b.id === +el.dataset.id)) el.remove();
  });
  blocks.forEach(b => renderBlock(b));
}

// ============================================================
//  ãƒ•ã‚©ãƒ¼ãƒ æ›´æ–°
// ============================================================
function updateKey(key) {
  const z = Z();
  if (key === 'main') {
    const b = blocks.find(b => b.key === 'main');
    if (!b) return;
    const raw = document.getElementById('f-main').value;
    b.text = raw;
    // ãƒ•ã‚©ãƒ³ãƒˆå†è¨ˆç®—
    const lines = raw.split('\n').filter(l => l.trim().length > 0);
    const nL = Math.max(lines.length, 1);
    const maxCh = Math.max(...lines.map(l => l.length), 1);
    let mFS = (z.main.h * 0.92) / (nL * 1.18);
    const mFSw = (z.main.w * 0.94) / (maxCh * 0.95);
    mFS = Math.min(mFS, mFSw, z.main.w * 0.18);
    mFS = Math.max(mFS, 8);
    b.fs = mFS;
    const mTH = nL * mFS * 1.18;
    b.y = z.main.y + (z.main.h - mTH) / 2;
    renderBlock(b);
  } else if (key === 'loc') {
    const b = blocks.find(b => b.key === 'loc');
    if (b) { b.text = document.getElementById('f-loc').value; renderBlock(b); }
  } else if (key === 'pdate') {
    const b = blocks.find(b => b.key === 'pdate');
    if (b) { b.text = document.getElementById('f-pdate').value; renderBlock(b); }
  } else if (key === 'ptime') {
    const b = blocks.find(b => b.key === 'ptime');
    if (b) { b.text = 'æ™‚é–“å¸¯ã€€' + document.getElementById('f-ptime').value; renderBlock(b); }
  } else if (key === 'proj') {
    const b = blocks.find(b => b.key === 'proj');
    if (b) { b.text = document.getElementById('f-proj').value; renderBlock(b); }
  } else if (key === 'client') {
    const b = blocks.find(b => b.key === 'cli-val');
    if (b) { b.text = document.getElementById('f-client').value; renderBlock(b); reposCon(); }
  } else if (key === 'cont') {
    const b = blocks.find(b => b.key === 'con-val');
    if (b) { b.text = document.getElementById('f-cont').value; renderBlock(b); }
  }
  if (selectedId) updatePropPanel();
}

function reposCon() {
  const z = Z();
  const inFS   = z.info.h * 0.115;
  const inLH   = inFS * 1.55;
  const cliLines = document.getElementById('f-client').value.split('\n');
  const cliH   = cliLines.length * inLH;
  const cliTopY = z.info.y + z.info.h * 0.06;
  const conTopY = cliTopY + cliH + z.info.h * 0.06;
  ['con-lbl','con-val'].forEach(k => {
    const b = blocks.find(b => b.key === k);
    if (b) { b.y = conTopY; renderBlock(b); }
  });
}

// ============================================================
//  SELECT
// ============================================================
function selectBlock(id) {
  selectedId = id;
  blocks.forEach(b => renderBlock(b));
  updatePropPanel();
}

canvasEl.addEventListener('click', e => {
  if (e.target === canvasEl || e.target === bgWrap || e.target.closest('#svgBgWrap')) {
    selectedId = null;
    blocks.forEach(b => renderBlock(b));
    updatePropPanel();
  }
});

// ============================================================
//  PROPERTY PANEL
// ============================================================
function updatePropPanel() {
  const empty = document.getElementById('propEmpty');
  const ctrl  = document.getElementById('propCtrl');
  if (!selectedId) { empty.style.display='block'; ctrl.style.display='none'; return; }
  const b = getB(selectedId);
  if (!b) { empty.style.display='block'; ctrl.style.display='none'; return; }
  empty.style.display='none'; ctrl.style.display='block';

  document.getElementById('p-text').value   = b.text;
  document.getElementById('p-fs').value     = Math.round(b.fs * 10) / 10;
  document.getElementById('p-fs-v').textContent = Math.round(b.fs * 10) / 10;
  document.getElementById('p-lh').value     = b.lh;
  document.getElementById('p-lh-v').textContent = parseFloat(b.lh).toFixed(2);
  document.getElementById('p-ls').value     = b.ls || 0;
  document.getElementById('p-ls-v').textContent = (b.ls || 0).toFixed(1);
  document.getElementById('p-x').value      = Math.round(b.x);
  document.getElementById('p-y').value      = Math.round(b.y);
  document.getElementById('p-w').value      = Math.round(b.w);

  [400,700,900].forEach(w => document.getElementById(`wb-${w}`).classList.toggle('active', b.fw == w));
  document.querySelectorAll('.csw').forEach(sw => sw.classList.toggle('active', sw.dataset.c === b.color));
  ['left','center','right'].forEach(a => document.getElementById(`ab-${a}`).classList.toggle('active', b.align === a));
}

function applyPropText() { const b=getB(selectedId); if(!b) return; b.text=document.getElementById('p-text').value; renderBlock(b); }
function applyPropFS()   { const b=getB(selectedId); if(!b) return; const v=parseFloat(document.getElementById('p-fs').value); b.fs=v; document.getElementById('p-fs-v').textContent=Math.round(v*10)/10; renderBlock(b); }
function applyPropLH()   { const b=getB(selectedId); if(!b) return; const v=parseFloat(document.getElementById('p-lh').value); b.lh=v; document.getElementById('p-lh-v').textContent=v.toFixed(2); renderBlock(b); }
function applyPropLS()   { const b=getB(selectedId); if(!b) return; const v=parseFloat(document.getElementById('p-ls').value); b.ls=v; document.getElementById('p-ls-v').textContent=v.toFixed(1); renderBlock(b); }
function applyWeight(w)  { const b=getB(selectedId); if(!b) return; b.fw=w; [400,700,900].forEach(ww=>document.getElementById(`wb-${ww}`).classList.toggle('active',ww==w)); renderBlock(b); }
function applyColor(el)  { const b=getB(selectedId); if(!b) return; b.color=el.dataset.c; document.querySelectorAll('.csw').forEach(sw=>sw.classList.toggle('active',sw.dataset.c===b.color)); renderBlock(b); }
function applyColorHex(h){ const b=getB(selectedId); if(!b) return; b.color=h; document.querySelectorAll('.csw').forEach(sw=>sw.classList.remove('active')); renderBlock(b); }
function applyAlign(a)   { const b=getB(selectedId); if(!b) return; b.align=a; ['left','center','right'].forEach(aa=>document.getElementById(`ab-${aa}`).classList.toggle('active',aa===a)); renderBlock(b); }
function applyPropPos()  { const b=getB(selectedId); if(!b) return; b.x=parseFloat(document.getElementById('p-x').value)||0; b.y=parseFloat(document.getElementById('p-y').value)||0; renderBlock(b); }
function applyPropW()    { const b=getB(selectedId); if(!b) return; b.w=parseFloat(document.getElementById('p-w').value)||50; renderBlock(b); }

// ============================================================
//  DRAG
// ============================================================
function startDrag(e, id) {
  e.preventDefault();
  selectBlock(id);
  const b = getB(id);
  dragState = { id, sx:e.clientX, sy:e.clientY, bx:b.x, by:b.y };
}

document.addEventListener('mousemove', e => {
  if (dragState) {
    const dx = px2vb(e.clientX - dragState.sx);
    const dy = px2vb(e.clientY - dragState.sy);
    const b  = getB(dragState.id);
    b.x = Math.round((dragState.bx + dx) * 2) / 2;
    b.y = Math.round((dragState.by + dy) * 2) / 2;
    renderBlock(b);
    updatePropPanel();
    const tt = document.getElementById('posTT');
    tt.style.display='block';
    tt.style.left = (vb2px(b.x) + vb2px(b.w) + 4) + 'px';
    tt.style.top  = vb2px(b.y) + 'px';
    tt.textContent = `X:${Math.round(b.x)} Y:${Math.round(b.y)}`;
    return;
  }
  if (resizeState) {
    const dx = px2vb(e.clientX - resizeState.sx);
    const b  = getB(resizeState.id);
    b.w = Math.max(20, resizeState.sw + dx);
    renderBlock(b); updatePropPanel();
  }
});

document.addEventListener('mouseup', () => {
  dragState = resizeState = null;
  document.getElementById('posTT').style.display = 'none';
});

// ============================================================
//  RESIZE
// ============================================================
function startResize(e, id) {
  e.preventDefault();
  const b = getB(id);
  resizeState = { id, sx:e.clientX, sw:b.w };
}

// ============================================================
//  ADD FREE BLOCK
// ============================================================
function addFreeBlock() {
  const z = Z();
  const b = mkBlock({
    text:'æ–°ã—ã„ãƒ†ã‚­ã‚¹ãƒˆ',
    x: z.inner.x + 10, y: z.inner.y + 10,
    w: z.inner.w * 0.6,
    fs: z.inner.w * 0.04, fw:700, color:'#111111',
  });
  renderBlock(b);
  selectBlock(b.id);
}

function deleteSelected() {
  if (!selectedId) return;
  blocks = blocks.filter(b => b.id !== selectedId);
  canvasEl.querySelector(`[data-id="${selectedId}"]`)?.remove();
  selectedId = null;
  updatePropPanel();
}

// ============================================================
//  HEADER / LOC / SIZE
// ============================================================
function setHeader(t) {
  document.getElementById('hb-mei').classList.toggle('active', t==='meiwaku');
  document.getElementById('hb-kyo').classList.toggle('active', t==='kyoryoku');
  const b = blocks.find(b => b.key === 'header');
  if (b) { b.text = t==='meiwaku' ? 'ã”è¿·æƒ‘ã‚’ãŠã‹ã‘ã—ã¾ã™' : 'ã”å”åŠ›ã‚’ãŠé¡˜ã„ã—ã¾ã™'; renderBlock(b); }
}

function toggleLoc() {
  showLoc = !showLoc;
  document.getElementById('locTog').classList.toggle('on', showLoc);
  document.getElementById('locField').style.display = showLoc ? 'block' : 'none';
  resetLayout();
}

function setSize(s) {
  sz = s;
  document.getElementById('sz-large').classList.toggle('active', s==='large');
  document.getElementById('sz-small').classList.toggle('active', s==='small');
  resetLayout();
}

function resetLayout() {
  setupCanvas();
  buildTemplate();
}

// ============================================================
//  SVG EXPORTï¼ˆèƒŒæ™¯SVGï¼‹ãƒ†ã‚­ã‚¹ãƒˆãƒ–ãƒ­ãƒƒã‚¯ã‚’åˆæˆï¼‰
// ============================================================
function exportSVG() {
  const FN = "'Noto Sans JP','Hiragino Sans','Yu Gothic',sans-serif";
  function esc(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

  // èƒŒæ™¯SVGã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼ˆdefs+shapesï¼‰ã‚’å–ã‚Šå‡ºã™
  const bgContent = (sz === 'large' ? SVG_LARGE : SVG_SMALL)
    .replace(/<\?xml[^>]*\?>\s*/, '')
    .replace(/<svg[^>]*>/, '')
    .replace(/<\/svg>/, '');

  // ãƒ†ã‚­ã‚¹ãƒˆãƒ–ãƒ­ãƒƒã‚¯ã‚’SVGãƒ†ã‚­ã‚¹ãƒˆã«å¤‰æ›
  let txtSVG = '';
  blocks.forEach(b => {
    const lines = b.text.split('\n');
    const lh = b.fs * (parseFloat(b.lh) || 1.2);
    const ls = b.ls ? ` letter-spacing="${b.ls}"` : '';
    lines.forEach((line, i) => {
      let tx = b.x, anchor = 'start';
      if (b.align === 'center') { tx = b.x + b.w / 2; anchor = 'middle'; }
      else if (b.align === 'right') { tx = b.x + b.w; anchor = 'end'; }
      txtSVG += `\n<text x="${tx}" y="${b.y + b.fs * 0.87 + i * lh}" font-size="${b.fs}" font-weight="${b.fw}" fill="${b.color}" text-anchor="${anchor}" font-family="${FN}"${ls} xml:space="preserve">${esc(line)}</text>`;
    });
  });

  const svg = `<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 ${VB.w} ${VB.h}" width="${VB.w}px" height="${VB.h}px">
  <defs>
    <style>@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900');</style>
  </defs>
  <rect width="${VB.w}" height="${VB.h}" fill="white"/>
  ${bgContent}
  ${txtSVG}
</svg>`;

  const blob = new Blob([svg], {type:'image/svg+xml;charset=utf-8'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `å·¥äº‹æ¨™ç¤ºæ¿_${sz==='large'?'1100x1400':'800x900'}.svg`;
  a.click();
}

// ============================================================
//  INIT
// ============================================================
window.addEventListener('resize', () => { setupCanvas(); renderAll(); applyTransform(); });
window.addEventListener('DOMContentLoaded', () => {
  // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰å¾©å…ƒã‚’è©¦ã¿ã‚‹
  if (!loadFromLocal()) {
    resetLayout();
  }
  // è‡ªå‹•ä¿å­˜ï¼ˆ30ç§’ã”ã¨ï¼‰
  setInterval(autoSave, 30000);
});

// ============================================================
//  TOAST é€šçŸ¥
// ============================================================
function showToast(msg, duration=2000) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), duration);
}

// ============================================================
//  çŠ¶æ…‹ã‚’ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«åé›†
// ============================================================
function collectState() {
  return {
    version: 1,
    sz,
    showLoc,
    headerType: document.getElementById('hb-mei').classList.contains('active') ? 'meiwaku' : 'kyoryoku',
    forms: {
      main:   document.getElementById('f-main').value,
      loc:    document.getElementById('f-loc').value,
      pdate:  document.getElementById('f-pdate').value,
      ptime:  document.getElementById('f-ptime').value,
      proj:   document.getElementById('f-proj').value,
      client: document.getElementById('f-client').value,
      cont:   document.getElementById('f-cont').value,
    },
    blocks: blocks.map(b => ({ ...b })),
    idCnt,
  };
}

// ============================================================
//  çŠ¶æ…‹ã‚’å¾©å…ƒ
// ============================================================
function applyState(state) {
  if (!state || state.version !== 1) return false;

  sz      = state.sz      || 'large';
  showLoc = state.showLoc || false;
  idCnt   = state.idCnt   || 0;

  // ã‚µã‚¤ã‚ºãƒœã‚¿ãƒ³
  document.getElementById('sz-large').classList.toggle('active', sz === 'large');
  document.getElementById('sz-small').classList.toggle('active', sz === 'small');

  // ãƒ˜ãƒƒãƒ€ãƒ¼
  const ht = state.headerType || 'meiwaku';
  document.getElementById('hb-mei').classList.toggle('active', ht === 'meiwaku');
  document.getElementById('hb-kyo').classList.toggle('active', ht === 'kyoryoku');

  // å·¥äº‹å ´æ‰€ãƒˆã‚°ãƒ«
  document.getElementById('locTog').classList.toggle('on', showLoc);
  document.getElementById('locField').style.display = showLoc ? 'block' : 'none';

  // ãƒ•ã‚©ãƒ¼ãƒ å€¤
  if (state.forms) {
    document.getElementById('f-main').value   = state.forms.main   || '';
    document.getElementById('f-loc').value    = state.forms.loc    || '';
    document.getElementById('f-pdate').value  = state.forms.pdate  || '';
    document.getElementById('f-ptime').value  = state.forms.ptime  || '';
    document.getElementById('f-proj').value   = state.forms.proj   || '';
    document.getElementById('f-client').value = state.forms.client || '';
    document.getElementById('f-cont').value   = state.forms.cont   || '';
  }

  // ãƒ–ãƒ­ãƒƒã‚¯å¾©å…ƒ
  blocks = state.blocks || [];

  // ã‚­ãƒ£ãƒ³ãƒã‚¹å†æ§‹ç¯‰
  setupCanvas();
  renderAll();
  updatePropPanel();

  return true;
}

// ============================================================
//  â‘  ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜
// ============================================================
const LS_KEY = 'koji-sign-state';

function saveToLocal() {
  try {
    localStorage.setItem(LS_KEY, JSON.stringify(collectState()));
    showToast('ğŸ’¾ ä¿å­˜ã—ã¾ã—ãŸ');
    // ä¿å­˜ãƒœã‚¿ãƒ³ã«ä¸€æ™‚çš„ã«ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
    const btn = document.getElementById('btnSave');
    btn.textContent = 'âœ… ä¿å­˜æ¸ˆã¿';
    setTimeout(() => { btn.textContent = 'ğŸ’¾ ä¿å­˜'; }, 2000);
  } catch(e) {
    showToast('âš ï¸ ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
  }
}

function loadFromLocal() {
  try {
    const raw = localStorage.getItem(LS_KEY);
    if (!raw) return false;
    const state = JSON.parse(raw);
    const ok = applyState(state);
    if (ok) showToast('ğŸ“‚ å‰å›ã®ä½œæ¥­ã‚’å¾©å…ƒã—ã¾ã—ãŸ');
    return ok;
  } catch(e) {
    return false;
  }
}

function autoSave() {
  try {
    localStorage.setItem(LS_KEY, JSON.stringify(collectState()));
    // é™ã‹ã«è‡ªå‹•ä¿å­˜ï¼ˆãƒˆãƒ¼ã‚¹ãƒˆä¸è¦ï¼‰
  } catch(e) {}
}

// ============================================================
//  â‘¡ JSON ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ / ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
// ============================================================
function exportJSON() {
  const state = collectState();
  const json  = JSON.stringify(state, null, 2);
  const blob  = new Blob([json], { type: 'application/json;charset=utf-8' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  // ãƒ•ã‚¡ã‚¤ãƒ«åã«å·¥äº‹åãƒ»æ—¥ä»˜ã‚’å«ã‚ã‚‹
  const proj = document.getElementById('f-proj').value.replace(/[\s\/\\:*?"<>|]/g, '_').slice(0, 20);
  const date = new Date().toISOString().slice(0,10);
  a.download = `çœ‹æ¿_${proj}_${date}.json`;
  a.click();
  showToast('ğŸ“¤ JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
}

function importJSON(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const state = JSON.parse(e.target.result);
      const ok = applyState(state);
      if (ok) {
        showToast('âœ… ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
        // ãƒ­ãƒ¼ã‚«ãƒ«ã«ã‚‚ä¿å­˜
        localStorage.setItem(LS_KEY, JSON.stringify(state));
      } else {
        showToast('âš ï¸ ãƒ•ã‚¡ã‚¤ãƒ«ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
      }
    } catch(err) {
      showToast('âš ï¸ èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
    // inputã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆåŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†åº¦èª­ã‚ã‚‹ï¼‰
    event.target.value = '';
  };
  reader.readAsText(file);
}
</script>
</body>
</html>
