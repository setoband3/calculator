<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å·¥äº‹æ¨™ç¤ºæ¿ ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ„ãƒ¼ãƒ«</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&display=swap" rel="stylesheet">
<!-- opentype.js: ãƒ†ã‚­ã‚¹ãƒˆã‚’SVGãƒ‘ã‚¹ï¼ˆã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³ï¼‰ã«å¤‰æ›ã™ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
<script src="https://cdn.jsdelivr.net/npm/opentype.js@1.3.4/dist/opentype.min.js"></script>
<style>
*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }

:root {
  --blue:     #1d5fad;
  --blue2:    #0054a6;
  --ui-dark:  #1c2333;
  --ui-mid:   #2c3549;
  --ui-panel: #242d3f;
  --ui-border:#3a4560;
  --ui-hover: #334063;
  --ui-accent:#3b82f6;
  --ui-text:  #e8edf5;
  --ui-muted: #8896b0;
  --white:    #ffffff;
  --black:    #111111;
}

body {
  font-family:'Noto Sans JP',sans-serif;
  background:var(--ui-dark);
  color:var(--ui-text);
  height:100vh;
  overflow:hidden;
  user-select:none;
}

.app {
  display:grid;
  grid-template-rows:48px 1fr;
  grid-template-columns:var(--left-w,320px) 4px 1fr 4px var(--right-w,280px);
  height:100vh;
}

/* ãƒ‘ãƒãƒ«ãƒªã‚µã‚¤ã‚¶ãƒ¼ */
.resizer {
  background:var(--ui-border);
  cursor:col-resize;
  transition:background 0.15s;
  z-index:50;
}
.resizer:hover, .resizer.dragging { background:var(--ui-accent); }

/* TOP BAR */
.topbar {
  grid-column:1/-1;
  background:var(--ui-dark);
  border-bottom:1px solid var(--ui-border);
  display:flex; align-items:center;
  padding:0 14px; gap:8px; z-index:100;
}
.topbar-logo { font-size:13px; font-weight:900; color:var(--ui-accent); display:flex; align-items:center; gap:6px; margin-right:6px; }
.topbar-sep  { width:1px; height:24px; background:var(--ui-border); }
.tbtn {
  padding:5px 11px; border-radius:6px; border:1px solid var(--ui-border);
  background:var(--ui-panel); color:var(--ui-text); font-size:12px;
  font-family:'Noto Sans JP',sans-serif; cursor:pointer; transition:all 0.15s;
  display:flex; align-items:center; gap:4px; white-space:nowrap;
}
.tbtn:hover { background:var(--ui-hover); border-color:var(--ui-accent); }
.tbtn.primary { background:var(--ui-accent); border-color:var(--ui-accent); color:#fff; font-weight:700; }
.tbtn.primary:hover { background:#2563eb; }
.sz-pills { display:flex; align-items:center; gap:6px; margin-left:auto; font-size:11px; color:var(--ui-muted); }
.spill {
  padding:4px 10px; border-radius:20px; border:1px solid var(--ui-border);
  background:transparent; color:var(--ui-muted); font-size:11px;
  font-family:'Noto Sans JP',sans-serif; cursor:pointer; transition:all 0.15s;
}
.spill.active { border-color:var(--ui-accent); color:var(--ui-accent); background:rgba(59,130,246,0.1); }

/* LEFT PANEL */
.left-panel {
  background:var(--ui-panel); border-right:1px solid var(--ui-border);
  overflow-y:auto; padding:10px;
  display:flex; flex-direction:column; gap:9px;
}
.psec { font-size:10px; font-weight:700; color:var(--ui-muted); letter-spacing:2px; padding-bottom:4px; border-bottom:1px solid var(--ui-border); margin-bottom:2px; }
.fg  { display:flex; flex-direction:column; gap:3px; }
.fg label { font-size:11px; color:var(--ui-muted); }
.fg input, .fg textarea {
  padding:5px 8px; border:1px solid var(--ui-border); border-radius:5px;
  font-size:12px; font-family:'Noto Sans JP',sans-serif;
  color:var(--ui-text); background:var(--ui-mid);
  outline:none; transition:border-color 0.2s; resize:vertical;
}
.fg input:focus, .fg textarea:focus { border-color:var(--ui-accent); }
.fg textarea { min-height:46px; }
.fg .hint { font-size:10px; color:var(--ui-muted); }
.hsel { display:grid; grid-template-columns:1fr 1fr; gap:5px; }
.hbtn {
  padding:5px 3px; border:1px solid var(--ui-border); border-radius:5px;
  background:var(--ui-mid); cursor:pointer; text-align:center;
  font-size:11px; font-weight:500; font-family:'Noto Sans JP',sans-serif;
  line-height:1.4; transition:all 0.15s; color:var(--ui-text);
}
.hbtn.active { border-color:var(--ui-accent); background:rgba(59,130,246,0.15); color:var(--ui-accent); }
.togrow {
  display:flex; align-items:center; justify-content:space-between;
  padding:5px 8px; background:var(--ui-mid); border-radius:5px; border:1px solid var(--ui-border);
}
.togrow label { font-size:11px; color:var(--ui-muted); }
.tog { width:28px; height:16px; background:#444; border-radius:20px; cursor:pointer; position:relative; transition:background 0.2s; border:none; flex-shrink:0; }
.tog::after { content:''; width:12px; height:12px; background:#fff; border-radius:50%; position:absolute; top:2px; left:2px; transition:transform 0.2s; }
.tog.on { background:var(--ui-accent); }
.tog.on::after { transform:translateX(12px); }

/* CANVAS */
.canvas-area {
  background:#1a1a1a; overflow:hidden;
  display:flex; align-items:center; justify-content:center;
  position:relative; cursor:default;
  background-image:linear-gradient(rgba(255,255,255,0.02) 1px,transparent 1px),linear-gradient(90deg,rgba(255,255,255,0.02) 1px,transparent 1px);
  background-size:20px 20px;
}
.canvas-area.panning { cursor:grab; }
.canvas-area.panning:active { cursor:grabbing; }

/* ã‚ºãƒ¼ãƒ ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« */
.zoom-ctrl {
  position:absolute; bottom:12px; right:12px;
  display:flex; align-items:center; gap:4px; z-index:200;
  background:rgba(28,35,51,0.9); border:1px solid var(--ui-border);
  border-radius:8px; padding:4px 8px;
}
.zoom-btn {
  width:26px; height:26px; border-radius:5px;
  border:1px solid var(--ui-border); background:var(--ui-panel);
  color:var(--ui-text); font-size:16px; cursor:pointer;
  display:flex; align-items:center; justify-content:center;
  transition:all 0.15s; line-height:1;
}
.zoom-btn:hover { background:var(--ui-hover); border-color:var(--ui-accent); }
.zoom-label { font-size:11px; color:var(--ui-muted); min-width:38px; text-align:center; }

/* ã‚­ãƒ£ãƒ³ãƒã‚¹ãƒ©ãƒƒãƒ‘ãƒ¼ï¼ˆtransformç”¨ï¼‰ */
#canvasWrapper {
  position:absolute;
  transform-origin:0 0;
  will-change:transform;
}

#signCanvas {
  position:relative; flex-shrink:0;
  box-shadow:0 8px 60px rgba(0,0,0,0.7);
}

/* SVG background */
#svgBg {
  position:absolute; inset:0;
  width:100%; height:100%;
  pointer-events:none;
  z-index:0;
}

/* Text blocks */
.tblock {
  position:absolute; cursor:move;
  border:1.5px solid transparent; border-radius:2px;
  transition:border-color 0.1s;
  z-index:10; white-space:pre-wrap; word-break:break-all;
  line-height:1.2;
}
.tblock:hover { border-color:rgba(59,130,246,0.5); }
.tblock.selected { border-color:var(--ui-accent) !important; z-index:50; }
.tblock.selected::after {
  content:''; position:absolute; inset:-5px;
  border:1px dashed rgba(59,130,246,0.4); border-radius:3px; pointer-events:none;
}
.rhandle {
  display:none; position:absolute; bottom:-5px; right:-5px;
  width:10px; height:10px; background:var(--ui-accent); border-radius:50%;
  cursor:se-resize; z-index:60;
}
.tblock.selected .rhandle { display:block; }
.tblock.multi-selected { border-color:#f59e0b !important; z-index:45; }
.tblock.multi-selected::after {
  content:''; position:absolute; inset:-5px;
  border:1px dashed rgba(245,158,11,0.5); border-radius:3px; pointer-events:none;
}
/* æ•´åˆ—ãƒœã‚¿ãƒ³ */
.align-panel { display:flex; flex-direction:column; gap:4px; }
.align-row { display:flex; gap:3px; }
.albtn {
  flex:1; padding:4px 2px; border-radius:4px; border:1px solid var(--ui-border);
  background:var(--ui-mid); color:var(--ui-text); font-size:11px;
  cursor:pointer; text-align:center;
}
.albtn:hover { background:var(--ui-hover); border-color:var(--ui-accent); }

/* RIGHT PANEL */
.right-panel {
  background:var(--ui-panel); border-left:1px solid var(--ui-border);
  overflow-y:auto; padding:10px;
  display:flex; flex-direction:column; gap:8px;
}
.prop-empty { color:var(--ui-muted); font-size:12px; text-align:center; padding:20px 0; line-height:1.8; }
.slrow { display:flex; align-items:center; gap:6px; }
.slrow label { font-size:11px; color:var(--ui-muted); min-width:48px; }
.slrow input[type=range] { flex:1; accent-color:var(--ui-accent); }
.slrow .val { font-size:11px; color:var(--ui-accent); min-width:26px; text-align:right; }
.adj {
  padding:1px 5px; border-radius:4px; border:1px solid var(--ui-border);
  background:var(--ui-mid); color:var(--ui-text); font-size:11px;
  cursor:pointer; line-height:1.4; flex-shrink:0;
}
.adj:hover { background:var(--ui-hover); border-color:var(--ui-accent); }
.crow { display:flex; align-items:center; gap:5px; flex-wrap:wrap; }
.csw { width:20px; height:20px; border-radius:50%; border:2px solid transparent; cursor:pointer; transition:border-color 0.15s; flex-shrink:0; }
.csw.active { border-color:var(--ui-accent); }
.arow, .wrow { display:flex; gap:3px; }
.abtn, .wbtn {
  flex:1; padding:4px; border:1px solid var(--ui-border); border-radius:4px;
  background:var(--ui-mid); color:var(--ui-muted);
  font-size:12px; cursor:pointer; text-align:center; transition:all 0.15s;
  font-family:'Noto Sans JP',sans-serif;
}
.abtn.active, .abtn:hover,
.wbtn.active, .wbtn:hover { border-color:var(--ui-accent); color:var(--ui-accent); background:rgba(59,130,246,0.1); }
.dbtn {
  width:100%; padding:7px; border:1px solid #e53e3e; border-radius:5px;
  background:transparent; color:#e53e3e; font-size:12px;
  font-family:'Noto Sans JP',sans-serif; cursor:pointer; transition:all 0.15s; margin-top:4px;
}
.dbtn:hover { background:#e53e3e; color:#fff; }
.pos-tt {
  position:absolute; background:rgba(0,0,0,0.8); color:#fff;
  font-size:10px; padding:2px 6px; border-radius:3px;
  pointer-events:none; z-index:300; display:none; white-space:nowrap;
}
/* ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ */
.toast {
  position:fixed; bottom:24px; left:50%; transform:translateX(-50%);
  background:#1e293b; color:#e8edf5; font-size:13px;
  padding:10px 20px; border-radius:8px; border:1px solid var(--ui-accent);
  box-shadow:0 4px 20px rgba(0,0,0,0.4);
  z-index:9999; pointer-events:none;
  opacity:0; transition:opacity 0.3s;
  white-space:nowrap;
}
.toast.show { opacity:1; }
/* è‡ªå‹•ä¿å­˜ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ */
.autosave-dot {
  width:7px; height:7px; border-radius:50%; background:#22c55e;
  display:inline-block; margin-right:4px;
  animation:pulse 2s infinite;
}
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }
</style>
</head>
<body>
<div class="app">

<!-- TOP BAR -->
<div class="topbar">
  <div class="topbar-logo">ğŸš§ çœ‹æ¿ãƒ‡ã‚¶ã‚¤ãƒŠãƒ¼</div>
  <div class="topbar-sep"></div>
  <button class="tbtn" onclick="resetLayout()">â†º ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå†èª­è¾¼</button>
  <button class="tbtn" onclick="saveAsDefault()" title="ç¾åœ¨ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¨ã—ã¦ä¿å­˜">â­ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä¿å­˜</button>
  <button class="tbtn" id="btnUndo" onclick="undo()" title="å…ƒã«æˆ»ã™ (Ctrl+Z)" disabled>â†© å…ƒã«æˆ»ã™</button>
  <button class="tbtn" onclick="openSettings()">âš™ï¸ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š</button>
  <button class="tbtn" onclick="addFreeBlock()">ï¼‹ ãƒ†ã‚­ã‚¹ãƒˆè¿½åŠ </button>
  <button class="tbtn" id="btnMultiMode" onclick="toggleMultiMode()" title="è¤‡æ•°é¸æŠãƒ¢ãƒ¼ãƒ‰ ON/OFF">â˜‘ è¤‡æ•°é¸æŠ</button>
  <div class="topbar-sep"></div>
  <div class="topbar-sep"></div>
  <button class="tbtn" onclick="saveToLocal()" id="btnSave">ğŸ’¾ ä¿å­˜</button>
  <button class="tbtn" onclick="exportJSON()">ğŸ“¤ JSONã§æ›¸ãå‡ºã—</button>
  <label class="tbtn" style="cursor:pointer;">ğŸ“‚ JSONèª­è¾¼<input type="file" accept=".json" onchange="importJSON(event)" style="display:none;"></label>
  <div class="topbar-sep"></div>
  <button class="tbtn primary" onclick="exportSVG()">ğŸ“ SVGå‡ºåŠ›</button>
  <div style="display:flex;align-items:center;gap:5px;background:var(--ui-mid);border:1px solid var(--ui-border);border-radius:6px;padding:3px 8px;" title="SVGå‡ºåŠ›æ™‚ã®ãƒ†ã‚­ã‚¹ãƒˆå‚ç›´ä½ç½®è£œæ­£">
    <span style="font-size:10px;color:var(--ui-muted);white-space:nowrap;">â†• SVGè£œæ­£</span>
    <input type="range" id="svgOffsetSlider" min="-2" max="2" step="0.05" value="-0.5"
      style="width:70px;accent-color:var(--ui-accent);"
      oninput="document.getElementById('svgOffsetVal').textContent=parseFloat(this.value).toFixed(2)">
    <span id="svgOffsetVal" style="font-size:10px;color:var(--ui-accent);min-width:32px;text-align:right;">-0.50</span>
  </div>
  <div class="sz-pills">
    <span>ã‚µã‚¤ã‚ºï¼š</span>
    <button class="spill active" id="sz-large" onclick="setSize('large')">å¤§ 1100Ã—1400</button>
    <button class="spill" id="sz-small" onclick="setSize('small')">å° 800Ã—900</button>
  </div>
</div>

<!-- LEFT PANEL -->
<div class="left-panel" id="leftPanel">
  <div><div class="psec">ãƒ˜ãƒƒãƒ€ãƒ¼æ–‡è¨€</div>
    <div class="hsel">
      <button class="hbtn active" id="hb-mei" onclick="setHeader('meiwaku')">ã”è¿·æƒ‘ã‚’<br>ãŠã‹ã‘ã—ã¾ã™</button>
      <button class="hbtn" id="hb-kyo" onclick="setHeader('kyoryoku')">ã”å”åŠ›ã‚’<br>ãŠé¡˜ã„ã—ã¾ã™</button>
    </div>
  </div>

  <div><div class="psec">å·¥äº‹å†…å®¹ã®è¦ç´„</div>
    <div class="fg">
      <textarea id="f-main" oninput="updateKey('main')" rows="3">å£Šã‚ŒãŸè­·å²¸ã‚’
ç›´ã—ã¦ã„ã¾ã™ã€‚</textarea>
      <span class="hint">æ–‡å­—æ•°ã§è‡ªå‹•ã‚µã‚¤ã‚ºèª¿æ•´</span>
    </div>
  </div>

  <div><div class="psec">å·¥äº‹å ´æ‰€ï¼ˆä»»æ„ï¼‰</div>
    <div class="togrow"><label>å·¥äº‹å ´æ‰€ã‚’è¡¨ç¤º</label><button class="tog" id="locTog" onclick="toggleLoc()"></button></div>
    <div id="locField" style="display:none;margin-top:5px;">
      <div class="fg"><input type="text" id="f-loc" placeholder="ä¾‹ï¼šæ—¥ç”°å¸‚å¤§å­—å°é‡å­—ä¸­å±±åœ°å†…" oninput="updateKey('loc')"></div>
    </div>
  </div>

  <div><div class="psec">å·¥æœŸãƒ»æ™‚é–“å¸¯</div>
    <div class="fg"><label>å·¥æœŸ</label><input type="text" id="f-pdate" value="ä»¤å’Œï¼—å¹´ï¼’æœˆ28æ—¥ã¾ã§" oninput="updateKey('pdate')"></div>
    <div class="fg" style="margin-top:4px;"><label>æ™‚é–“å¸¯</label><input type="text" id="f-ptime" value="8:00 ï½ 17:00" oninput="updateKey('ptime')"></div>
  </div>

  <div><div class="psec">å·¥äº‹å</div>
    <div class="fg"><input type="text" id="f-proj" value="èŠ±æœˆå·ä¸‰å’Œåœ°åŒºå¤–ç½å®³å¾©æ—§å·¥äº‹" oninput="updateKey('proj')"></div>
  </div>

  <div><div class="psec">ç™ºæ³¨è€…</div>
    <div class="fg"><textarea id="f-client" rows="3" oninput="updateKey('client')">å›½åœŸäº¤é€šçœã€€ä¹å·åœ°æ–¹æ•´å‚™å±€
ç­‘å¾Œå·æ²³å·äº‹å‹™æ‰€ã€€æ—¥ç”°å‡ºå¼µæ‰€
é›»è©±ã€€0972ï¼23ï¼5291</textarea></div>
  </div>

  <div><div class="psec">æ–½å·¥è€…</div>
    <div class="fg"><textarea id="f-cont" rows="3" oninput="updateKey('cont')">ç”°ä¸­å»ºè¨­æ ªå¼ä¼šç¤¾
é›»è©±ã€€0973ï¼23ï¼8185
ç¾å ´ä»£ç†äººã€€å±±æœ¬ã€€äº®ä¸€</textarea></div>
  </div>
</div>

<!-- LEFT RESIZER -->
<div class="resizer" id="resizerLeft"></div>

<!-- CANVAS -->
<div class="canvas-area" id="canvasArea">
  <div id="canvasWrapper">
    <div id="signCanvas">
      <div id="svgBgWrap"></div>
    </div>
  </div>
  <div class="pos-tt" id="posTT"></div>
  <!-- ã‚ºãƒ¼ãƒ ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
  <div class="zoom-ctrl">
    <button class="zoom-btn" onclick="zoomBy(-0.1)">ï¼</button>
    <span class="zoom-label" id="zoomLabel">100%</span>
    <button class="zoom-btn" onclick="zoomBy(+0.1)">ï¼‹</button>
    <button class="zoom-btn" onclick="zoomFit()" title="å…¨ä½“è¡¨ç¤º" style="font-size:12px;width:auto;padding:0 6px;">åˆã‚ã›ã‚‹</button>
  </div>
</div>

<!-- RIGHT RESIZER -->
<div class="resizer" id="resizerRight"></div>

<!-- RIGHT PANEL -->
<div class="right-panel" id="rightPanel">
  <div class="psec">ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£</div>
  <div class="prop-empty" id="propEmpty">â† ãƒ†ã‚­ã‚¹ãƒˆã‚’<br>ã‚¯ãƒªãƒƒã‚¯ã—ã¦<br>é¸æŠã—ã¦ãã ã•ã„</div>

  <!-- è¤‡æ•°é¸æŠãƒ‘ãƒãƒ« -->
  <div id="multiCtrl" style="display:none;">
    <div style="font-size:11px;color:var(--ui-accent);margin-bottom:6px;" id="multiCount">2å€‹é¸æŠä¸­</div>
    <div class="psec">æ•´åˆ—</div>
    <div class="align-panel">
      <div class="align-row">
        <button class="albtn" onclick="alignBlocks('left')"    title="å·¦ç«¯æƒãˆ">â—§ å·¦</button>
        <button class="albtn" onclick="alignBlocks('centerX')" title="æ°´å¹³ä¸­å¤®">â¬œ ä¸­</button>
        <button class="albtn" onclick="alignBlocks('right')"   title="å³ç«¯æƒãˆ">â—¨ å³</button>
      </div>
      <div class="align-row">
        <button class="albtn" onclick="alignBlocks('top')"     title="ä¸Šç«¯æƒãˆ">â¬† ä¸Š</button>
        <button class="albtn" onclick="alignBlocks('centerY')" title="å‚ç›´ä¸­å¤®">â†• ä¸­</button>
        <button class="albtn" onclick="alignBlocks('bottom')"  title="ä¸‹ç«¯æƒãˆ">â¬‡ ä¸‹</button>
      </div>
    </div>
  </div>
  <div id="propCtrl" style="display:none;">
    <div class="psec">ãƒ†ã‚­ã‚¹ãƒˆ</div>
    <div class="fg"><textarea id="p-text" rows="3" oninput="applyPropText()"></textarea></div>

    <div class="psec" style="margin-top:7px;">ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º</div>
    <div class="slrow">
      <label>ã‚µã‚¤ã‚º</label>
      <input type="range" id="p-fs" min="6" max="150" step="0.5" oninput="applyPropFS()">
      <span class="val" id="p-fs-v">32</span>
      <button class="adj" onclick="stepSlider('p-fs',-0.5,applyPropFS)">ï¼</button>
      <button class="adj" onclick="stepSlider('p-fs',+0.5,applyPropFS)">ï¼‹</button>
    </div>

    <div class="psec" style="margin-top:7px;">å¤ªã•</div>
    <div class="wrow">
      <button class="wbtn" id="wb-400" onclick="applyWeight(400)">æ¨™æº–</button>
      <button class="wbtn" id="wb-700" onclick="applyWeight(700)">å¤ªå­—</button>
      <button class="wbtn active" id="wb-900" onclick="applyWeight(900)">æ¥µå¤ª</button>
    </div>

    <div class="psec" style="margin-top:7px;">æ–‡å­—è‰²</div>
    <div class="crow">
      <div class="csw active" style="background:#111" data-c="#111111" onclick="applyColor(this)"></div>
      <div class="csw" style="background:#fff;outline:1px solid #555" data-c="#ffffff" onclick="applyColor(this)"></div>
      <div class="csw" style="background:#1d5fad" data-c="#1d5fad" onclick="applyColor(this)"></div>
      <div class="csw" style="background:#e74c3c" data-c="#e74c3c" onclick="applyColor(this)"></div>
      <input type="color" id="p-color" value="#111111" oninput="applyColorHex(this.value)" style="width:20px;height:20px;border:none;background:none;cursor:pointer;padding:0;border-radius:50%;">
    </div>

    <div class="psec" style="margin-top:7px;">è¡Œé–“</div>
    <div class="slrow">
      <label>è¡Œé–“</label>
      <input type="range" id="p-lh" min="0.9" max="2.5" step="0.05" value="1.2" oninput="applyPropLH()">
      <span class="val" id="p-lh-v">1.20</span>
      <button class="adj" onclick="stepSlider('p-lh',-0.05,applyPropLH)">ï¼</button>
      <button class="adj" onclick="stepSlider('p-lh',+0.05,applyPropLH)">ï¼‹</button>
    </div>

    <div class="psec" style="margin-top:7px;">æ–‡å­—é–“éš”</div>
    <div class="slrow">
      <label>å­—é–“</label>
      <input type="range" id="p-ls" min="-5" max="30" step="0.5" value="0" oninput="applyPropLS()">
      <span class="val" id="p-ls-v">0</span>
      <button class="adj" onclick="stepSlider('p-ls',-0.5,applyPropLS)">ï¼</button>
      <button class="adj" onclick="stepSlider('p-ls',+0.5,applyPropLS)">ï¼‹</button>
    </div>

    <div class="psec" style="margin-top:7px;">æ–‡å­—æƒãˆ</div>
    <div class="arow">
      <button class="abtn active" id="ab-left"   onclick="applyAlign('left')">â‰¡</button>
      <button class="abtn"        id="ab-center" onclick="applyAlign('center')">â˜°</button>
      <button class="abtn"        id="ab-right"  onclick="applyAlign('right')">â‰£</button>
    </div>

    <div class="psec" style="margin-top:7px;">ä½ç½®ãƒ»å¹… (px)</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;">
      <div class="fg">
        <label>X</label>
        <div style="display:flex;gap:2px;align-items:center;">
          <input type="number" id="p-x" oninput="applyPropPos()" style="width:100%;">
          <button class="adj" onclick="nudgePos('x',-1)">ï¼</button>
          <button class="adj" onclick="nudgePos('x',+1)">ï¼‹</button>
        </div>
      </div>
      <div class="fg">
        <label>Y</label>
        <div style="display:flex;gap:2px;align-items:center;">
          <input type="number" id="p-y" oninput="applyPropPos()" style="width:100%;">
          <button class="adj" onclick="nudgePos('y',-1)">ï¼</button>
          <button class="adj" onclick="nudgePos('y',+1)">ï¼‹</button>
        </div>
      </div>
      <div class="fg">
        <label>å¹…</label>
        <div style="display:flex;gap:2px;align-items:center;">
          <input type="number" id="p-w" oninput="applyPropW()" style="width:100%;">
          <button class="adj" onclick="nudgeW(-1)">ï¼</button>
          <button class="adj" onclick="nudgeW(+1)">ï¼‹</button>
        </div>
      </div>
    </div>

    <button class="dbtn" onclick="deleteSelected()">ğŸ—‘ å‰Šé™¤</button>
  </div>
</div>

</div><!-- .app -->

<div class="toast" id="toast"></div>

<!-- ============================================================
     ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«
============================================================ -->
<div id="settingsOverlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:10000; align-items:center; justify-content:center;">
  <div style="background:var(--ui-panel); border:1px solid var(--ui-border); border-radius:12px; width:480px; max-width:95vw; max-height:90vh; overflow-y:auto; padding:20px; display:flex; flex-direction:column; gap:12px;">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <div style="font-size:14px; font-weight:900; color:var(--ui-accent);">âš™ï¸ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š</div>
      <button onclick="closeSettings()" style="background:none; border:none; color:var(--ui-muted); font-size:20px; cursor:pointer; line-height:1;">Ã—</button>
    </div>
    <div style="font-size:11px; color:var(--ui-muted); border-bottom:1px solid var(--ui-border); padding-bottom:8px;">
      ã€Œãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå†èª­è¾¼ã€ãƒœã‚¿ãƒ³ã§èª­ã¿è¾¼ã¾ã‚Œã‚‹åˆæœŸå€¤ã‚’å¤‰æ›´ã§ãã¾ã™ã€‚<br>
      è¨­å®šå¾Œã¯ã€Œã“ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’ä¿å­˜ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚
    </div>

    <div class="fg"><div class="psec">ãƒ˜ãƒƒãƒ€ãƒ¼æ–‡è¨€</div>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:5px;">
        <button class="hbtn active" id="def-hb-mei" onclick="setDefHeader('meiwaku')">ã”è¿·æƒ‘ã‚’<br>ãŠã‹ã‘ã—ã¾ã™</button>
        <button class="hbtn" id="def-hb-kyo" onclick="setDefHeader('kyoryoku')">ã”å”åŠ›ã‚’<br>ãŠé¡˜ã„ã—ã¾ã™</button>
      </div>
    </div>

    <div class="fg"><div class="psec">å·¥äº‹å†…å®¹ã®è¦ç´„</div>
      <textarea id="def-main" rows="3" style="padding:5px 8px; border:1px solid var(--ui-border); border-radius:5px; font-size:12px; font-family:'Noto Sans JP',sans-serif; color:var(--ui-text); background:var(--ui-mid); outline:none; resize:vertical;"></textarea>
    </div>

    <div class="fg"><div class="psec">å·¥æœŸ</div>
      <input type="text" id="def-pdate" style="padding:5px 8px; border:1px solid var(--ui-border); border-radius:5px; font-size:12px; font-family:'Noto Sans JP',sans-serif; color:var(--ui-text); background:var(--ui-mid); outline:none;">
    </div>

    <div class="fg"><div class="psec">æ™‚é–“å¸¯</div>
      <input type="text" id="def-ptime" style="padding:5px 8px; border:1px solid var(--ui-border); border-radius:5px; font-size:12px; font-family:'Noto Sans JP',sans-serif; color:var(--ui-text); background:var(--ui-mid); outline:none;">
    </div>

    <div class="fg"><div class="psec">å·¥äº‹å</div>
      <input type="text" id="def-proj" style="padding:5px 8px; border:1px solid var(--ui-border); border-radius:5px; font-size:12px; font-family:'Noto Sans JP',sans-serif; color:var(--ui-text); background:var(--ui-mid); outline:none;">
    </div>

    <div class="fg"><div class="psec">ç™ºæ³¨è€…</div>
      <textarea id="def-client" rows="3" style="padding:5px 8px; border:1px solid var(--ui-border); border-radius:5px; font-size:12px; font-family:'Noto Sans JP',sans-serif; color:var(--ui-text); background:var(--ui-mid); outline:none; resize:vertical;"></textarea>
    </div>

    <div class="fg"><div class="psec">æ–½å·¥è€…</div>
      <textarea id="def-cont" rows="3" style="padding:5px 8px; border:1px solid var(--ui-border); border-radius:5px; font-size:12px; font-family:'Noto Sans JP',sans-serif; color:var(--ui-text); background:var(--ui-mid); outline:none; resize:vertical;"></textarea>
    </div>

    <div style="display:flex; gap:8px; margin-top:4px;">
      <button onclick="saveDefaultSettings()" style="flex:1; padding:9px; background:var(--ui-accent); border:none; border-radius:6px; color:#fff; font-size:13px; font-weight:700; font-family:'Noto Sans JP',sans-serif; cursor:pointer;">ğŸ’¾ ã“ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’ä¿å­˜</button>
      <button onclick="closeSettings()" style="padding:9px 14px; background:var(--ui-mid); border:1px solid var(--ui-border); border-radius:6px; color:var(--ui-text); font-size:13px; font-family:'Noto Sans JP',sans-serif; cursor:pointer;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>
</div>

<script>
// ============================================================
//  SVG èƒŒæ™¯ãƒ‡ãƒ¼ã‚¿ï¼ˆå®Ÿãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³åŸ‹ã‚è¾¼ã¿ï¼‰
// ============================================================
const SVG_LARGE = `<svg id="_ãƒ¬ã‚¤ãƒ¤ãƒ¼_1" xmlns="http://www.w3.org/2000/svg" version="1.1" viewBox="0 0 1190.55 841.89">
  <defs><style>.st0{fill:#0054a6;}.st1{fill:none;stroke:#231f20;}</style></defs>
  <rect class="st1" x="117.45" y="155.92" width="311.81" height="396.85"/>
  <path class="st0" d="M121.62,160.09v388.51h303.47V160.09H121.62ZM422.1,545.6H124.62V212.02h297.47v333.58h.01Z"/>
  <path class="st0" d="M128.16,337.04v69.88h290.4v-69.88H128.16ZM415.56,340.04v63.88H131.16v-63.88h284.4Z"/>
  <path class="st0" d="M402.54,411.06H144.17c-8.84,0-16.02,6.67-16.02,14.9s7.17,14.9,16.02,14.9h258.37c8.84,0,16.02-6.67,16.02-14.9s-7.17-14.9-16.02-14.9h0Z"/>
</svg>`;

const SVG_SMALL = `<svg id="_ãƒ¬ã‚¤ãƒ¤ãƒ¼_1" data-name="ãƒ¬ã‚¤ãƒ¤ãƒ¼_1" xmlns="http://www.w3.org/2000/svg" version="1.1" viewBox="0 0 1190.55 841.89">
  <defs><style>.st0{fill:#0054a6;}.st1{stroke:#231f20;}.st1,.st2{fill:none;}.st2{stroke:#1d5fad;stroke-miterlimit:10;stroke-width:1.6px;}.st3{fill:#1d5fad;}</style></defs>
  <rect class="st3" x="152.75" y="177.05" width="215.84" height="28.85"/>
  <rect class="st1" x="147.28" y="171.99" width="226.77" height="255.12"/>
  <path class="st0" d="M369.67,423.14h-218v-247.17h218v247.17ZM153.83,420.98h213.68v-242.85h-213.68v242.85Z"/>
  <rect class="st2" x="158.52" y="284.4" width="204.03" height="41.36"/>
  <path class="st3" d="M355.14,328.14s0,0,0,0h-188.33s0,0,0,0c-4.57,0-8.27,3.9-8.27,8.72s3.7,8.72,8.27,8.72h188.34c4.57,0,8.27-3.9,8.27-8.72s-3.7-8.72-8.27-8.72Z"/>
</svg>`;

// ============================================================
//  SVGã®åº§æ¨™ç³»ï¼šviewBox = 0 0 1190.55 841.89 (æ¨ªå‘ãA3)
//  çœ‹æ¿ã®æ åº§æ¨™ï¼ˆå¤§ãƒ»å°ãã‚Œãã‚Œï¼‰
// ============================================================
const VB = { w: 1190.55, h: 841.89 }; // viewBox

// å¤§ã‚µã‚¤ã‚ºçœ‹æ¿ã®å„ã‚¨ãƒªã‚¢åº§æ¨™ï¼ˆviewBoxåº§æ¨™ï¼‰
const ZONES_LARGE = {
  outerBox: { x:117.45, y:155.92, w:311.81, h:396.85 },
  // å†…å´æœ‰åŠ¹ã‚¨ãƒªã‚¢ï¼ˆå¤–æ ã‹ã‚‰ç½«ç·šåˆ†å†…å´ï¼‰
  inner:    { x:124.62, y:160.09, w:297.47, h:385.51 },
  // ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆé’å¸¯ï¼‰= innerã®topã€œ212.02
  header:   { x:124.62, y:160.09, w:297.47, h:51.93 },
  // ãƒ¡ã‚¤ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ = 212.02ã€œ337.04
  main:     { x:124.62, y:212.02, w:297.47, h:125.02 },
  // å·¥æœŸæ  = 337.04ã€œ406.92
  period:   { x:128.16, y:337.04, w:290.40, h:69.88  },
  // å·¥äº‹åå¸¯ï¼ˆpillï¼‰= 411.06ã€œ440.86
  projBand: { x:128.16, y:411.06, w:290.40, h:29.80  },
  // ç™ºæ³¨è€…ãƒ»æ–½å·¥è€…ã‚¨ãƒªã‚¢ = 440.86ã€œ545.60
  info:     { x:124.62, y:440.86, w:297.47, h:104.74 },
};

// å°ã‚µã‚¤ã‚ºçœ‹æ¿ã®å„ã‚¨ãƒªã‚¢åº§æ¨™ï¼ˆviewBoxåº§æ¨™ï¼‰
const ZONES_SMALL = {
  outerBox: { x:147.28, y:171.99, w:226.77, h:255.12 },
  inner:    { x:153.83, y:177.05, w:213.68, h:246.09 },
  // ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆé’å¸¯ï¼‰ = 177.05ã€œ205.90
  header:   { x:153.83, y:177.05, w:213.68, h:28.85  },
  // ãƒ¡ã‚¤ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ = 205.90ã€œ284.40
  main:     { x:153.83, y:205.90, w:213.68, h:78.50  },
  // å·¥æœŸæ ï¼ˆé’ç·šæ ï¼‰ = 284.40ã€œ325.76
  period:   { x:158.52, y:284.40, w:204.03, h:41.36  },
  // å·¥äº‹åå¸¯ï¼ˆpillï¼‰ = 328.14ã€œ345.58
  projBand: { x:158.52, y:328.14, w:195.01, h:17.44  },
  // ç™ºæ³¨è€…ãƒ»æ–½å·¥è€… = 345.58ã€œ423.14
  info:     { x:153.83, y:345.58, w:213.68, h:77.56  },
};

// ============================================================
//  STATE
// ============================================================
let sz       = 'large';
let showLoc  = false;
let scale    = 1;       // canvasã®px/viewBoxå˜ä½
let blocks   = [];
let selectedId = null;
let multiSelected = []; // è¤‡æ•°é¸æŠIDãƒªã‚¹ãƒˆ
let multiMode = false;  // è¤‡æ•°é¸æŠãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒˆã‚°ãƒ«ï¼‰
let dragState  = null;
let resizeState = null;
let idCnt = 0;

// Undoå±¥æ­´ï¼ˆæœ€å¤§20ä»¶ï¼‰
let undoStack = [];
const UNDO_MAX = 20;

// ã‚ºãƒ¼ãƒ ãƒ»ãƒ‘ãƒ³
let zoomLevel = 1.0;
let panX = 0, panY = 0;
let isPanning = false;
let panStart = null;
let spaceDown = false;

const canvasEl = document.getElementById('signCanvas');
const bgWrap   = document.getElementById('svgBgWrap');

// ============================================================
//  ã‚¹ã‚±ãƒ¼ãƒ«è¨ˆç®—
//  canvasã¯outerBoxåŸºæº–ã§ãƒ•ã‚£ãƒƒãƒˆã€vb2pxã¯ãã®æ¯”ç‡ã‚’ä½¿ã†
// ============================================================
function calcScale() {
  const area = document.getElementById('canvasArea');
  const mW = area.clientWidth  - 40;
  const mH = area.clientHeight - 40;
  const ob = (sz === 'large' ? ZONES_LARGE : ZONES_SMALL).outerBox;
  const s  = Math.min(mW / ob.w, mH / ob.h);
  return Math.max(s, 0.15);
}

// vb2px: viewBoxå˜ä½ â†’ pxï¼ˆouterBoxåŸºæº–ã‚¹ã‚±ãƒ¼ãƒ«ï¼‰
function vb2px(v) { return v * scale * zoomLevel; }
function px2vb(p) { return p / (scale * zoomLevel); }

// ============================================================
//  ZOOM & PAN
// ============================================================
function applyTransform() {
  const area    = document.getElementById('canvasArea');
  const wrapEl  = document.getElementById('canvasWrapper');
  const ob      = (sz === 'large' ? ZONES_LARGE : ZONES_SMALL).outerBox;
  const effectiveScale = scale * zoomLevel;

  // canvasã‚µã‚¤ã‚º = outerBox Ã— scale
  const cW = Math.round(ob.w * effectiveScale);
  const cH = Math.round(ob.h * effectiveScale);
  canvasEl.style.width  = cW + 'px';
  canvasEl.style.height = cH + 'px';

  const aW = area.clientWidth;
  const aH = area.clientHeight;
  const baseX = (aW - cW) / 2;
  const baseY = (aH - cH) / 2;

  wrapEl.style.transform = `translate(${baseX + panX}px, ${baseY + panY}px)`;
  wrapEl.style.transformOrigin = '0 0';

  // SVGèƒŒæ™¯: A3å…¨ä½“ã‚µã‚¤ã‚ºã§æã‹ã‚Œã¦ã„ã‚‹ã®ã§outerBoxåˆ†ã‚ªãƒ•ã‚»ãƒƒãƒˆ
  const svgEl = canvasEl.querySelector('svg');
  if (svgEl) {
    const svgW = Math.round(VB.w * effectiveScale);
    const svgH = Math.round(VB.h * effectiveScale);
    svgEl.style.position = 'absolute';
    svgEl.style.width    = svgW + 'px';
    svgEl.style.height   = svgH + 'px';
    svgEl.style.left     = -Math.round(ob.x * effectiveScale) + 'px';
    svgEl.style.top      = -Math.round(ob.y * effectiveScale) + 'px';
    svgEl.style.pointerEvents = 'none';
    svgEl.style.zIndex   = '0';
    svgEl.setAttribute('viewBox', `0 0 ${VB.w} ${VB.h}`);
  }

  // ãƒ–ãƒ­ãƒƒã‚¯ã®è¡¨ç¤ºä½ç½®ã‚’å†è¨ˆç®—ï¼ˆouterBoxåŸç‚¹ã‚ªãƒ•ã‚»ãƒƒãƒˆè¾¼ã¿ï¼‰
  blocks.forEach(b => renderBlock(b));

  document.getElementById('zoomLabel').textContent = Math.round(zoomLevel * 100) + '%';
}

function zoomBy(delta, cx, cy) {
  const newZoom = Math.max(0.2, Math.min(8, zoomLevel + delta));
  if (cx !== undefined) {
    const ratio = newZoom / zoomLevel;
    panX = cx - ratio * (cx - panX);
    panY = cy - ratio * (cy - panY);
  }
  zoomLevel = newZoom;
  applyTransform();
}

function zoomFit() {
  panX = 0; panY = 0; zoomLevel = 1.0;
  applyTransform();
}

// ãƒã‚¦ã‚¹ãƒ›ã‚¤ãƒ¼ãƒ«ã§ã‚ºãƒ¼ãƒ ï¼ˆã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã‚’ä¸­å¿ƒã«ï¼‰
document.getElementById('canvasArea').addEventListener('wheel', e => {
  e.preventDefault();
  const area = document.getElementById('canvasArea');
  const rect = area.getBoundingClientRect();

  // ã‚«ãƒ¼ã‚½ãƒ«ã®canvasAreaå†…åº§æ¨™
  const mouseX = e.clientX - rect.left;
  const mouseY = e.clientY - rect.top;

  const delta   = e.deltaY < 0 ? 0.12 : -0.12;
  const oldZoom = zoomLevel;
  const newZoom = Math.max(0.2, Math.min(8, oldZoom + delta));
  const ratio   = newZoom / oldZoom;

  // ã‚ºãƒ¼ãƒ å‰å¾Œã®ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºã¨baseOffsetå¤‰åŒ–ã‚’è€ƒæ…®ã—ã¦panã‚’è£œæ­£
  const oldCW = Math.round(VB.w * scale * oldZoom);
  const oldCH = Math.round(VB.h * scale * oldZoom);
  const newCW = Math.round(VB.w * scale * newZoom);
  const newCH = Math.round(VB.h * scale * newZoom);
  const aW = area.clientWidth;
  const aH = area.clientHeight;
  const oldBaseX = (aW - oldCW) / 2;
  const oldBaseY = (aH - oldCH) / 2;
  const newBaseX = (aW - newCW) / 2;
  const newBaseY = (aH - newCH) / 2;

  // ã‚«ãƒ¼ã‚½ãƒ«ã®ã‚­ãƒ£ãƒ³ãƒã‚¹å†…ã‚ªãƒ•ã‚»ãƒƒãƒˆ
  const cursorCX = mouseX - oldBaseX - panX;
  const cursorCY = mouseY - oldBaseY - panY;

  // ã‚ºãƒ¼ãƒ å¾Œã‚‚åŒã˜ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã«ãªã‚‹ã‚ˆã†panã‚’èª¿æ•´
  panX = mouseX - newBaseX - cursorCX * ratio;
  panY = mouseY - newBaseY - cursorCY * ratio;

  zoomLevel = newZoom;
  applyTransform();
}, { passive: false });

// ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼ï¼‹ãƒ‰ãƒ©ãƒƒã‚°ã§ãƒ‘ãƒ³
document.addEventListener('keydown', e => {
  if (e.code === 'Space' && !e.target.matches('input,textarea')) {
    spaceDown = true;
    document.getElementById('canvasArea').classList.add('panning');
    e.preventDefault();
  }
});
document.addEventListener('keyup', e => {
  if (e.code === 'Space') {
    spaceDown = false;
    isPanning = false;
    document.getElementById('canvasArea').classList.remove('panning');
  }
});

document.getElementById('canvasArea').addEventListener('mousedown', e => {
  if (spaceDown || e.button === 1) {
    isPanning = true;
    panStart  = { x: e.clientX - panX, y: e.clientY - panY };
    e.preventDefault();
  }
});

document.addEventListener('mousemove', e => {
  if (isPanning && panStart) {
    panX = e.clientX - panStart.x;
    panY = e.clientY - panStart.y;
    applyTransform();
  }
});

document.addEventListener('mouseup', e => {
  if (e.button === 1 || isPanning) {
    isPanning = false;
    panStart  = null;
  }
});

// ============================================================
//  ãƒ‘ãƒãƒ«ãƒªã‚µã‚¤ã‚º
// ============================================================
(function() {
  const app = document.querySelector('.app');

  // å·¦ãƒ‘ãƒãƒ«
  const rL = document.getElementById('resizerLeft');
  let draggingL = false;
  rL.addEventListener('mousedown', e => { draggingL = true; rL.classList.add('dragging'); e.preventDefault(); });
  document.addEventListener('mousemove', e => {
    if (!draggingL) return;
    const newW = Math.max(200, Math.min(500, e.clientX));
    app.style.setProperty('--left-w', newW + 'px');
  });
  document.addEventListener('mouseup', () => { draggingL = false; rL.classList.remove('dragging'); });

  // å³ãƒ‘ãƒãƒ«
  const rR = document.getElementById('resizerRight');
  let draggingR = false;
  rR.addEventListener('mousedown', e => { draggingR = true; rR.classList.add('dragging'); e.preventDefault(); });
  document.addEventListener('mousemove', e => {
    if (!draggingR) return;
    const newW = Math.max(200, Math.min(500, window.innerWidth - e.clientX));
    app.style.setProperty('--right-w', newW + 'px');
  });
  document.addEventListener('mouseup', () => { draggingR = false; rR.classList.remove('dragging'); });
})();

// ============================================================
//  CANVAS SETUP
// ============================================================
function setupCanvas() {
  scale = calcScale();

  // SVGèƒŒæ™¯ï¼ˆã‚µã‚¤ã‚ºã¯applyTransformãŒç®¡ç†ï¼‰
  bgWrap.innerHTML = sz === 'large' ? SVG_LARGE : SVG_SMALL;
  const svgEl = bgWrap.querySelector('svg');
  svgEl.style.cssText = `position:absolute;inset:0;width:100%;height:100%;pointer-events:none;z-index:0;`;

  canvasEl.style.background = '#fff';
  applyTransform();
}

// ============================================================
//  ç¾åœ¨ã®ZONESå–å¾—
// ============================================================
function Z() { return sz === 'large' ? ZONES_LARGE : ZONES_SMALL; }

// ============================================================
//  ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ–ãƒ­ãƒƒã‚¯ç”Ÿæˆ
// ============================================================
function buildTemplate() {
  blocks = [];
  canvasEl.querySelectorAll('.tblock').forEach(el => el.remove());
  selectedId = null;

  const isL = sz === 'large';

  // ---- ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ†ã‚­ã‚¹ãƒˆ ----
  const hdrText = document.getElementById('hb-mei').classList.contains('active')
    ? 'ã”è¿·æƒ‘ã‚’ãŠã‹ã‘ã—ã¾ã™' : 'ã”å”åŠ›ã‚’ãŠé¡˜ã„ã—ã¾ã™';
  mkBlock({
    key:'header', text: hdrText,
    x:  isL ? 137 : 161,
    y:  isL ? 173 : 179,
    w:  isL ? 270 : 194,
    fs: isL ? 25  : 18,
    fw: 700, color:'#ffffff', align:'center', lh:1.0,
  });

  // ---- ãƒ¡ã‚¤ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼ˆæ–‡å­—æ•°ã§è‡ªå‹•ã‚µã‚¤ã‚ºèª¿æ•´ï¼‰----
  const mainRaw   = document.getElementById('f-main').value;
  const mainLines = mainRaw.split('\n').filter(l => l.trim().length > 0);
  const nL    = Math.max(mainLines.length, 1);
  const maxCh = Math.max(...mainLines.map(l => l.length), 1);
  const mMaxFS = isL ? 40 : 29;
  const mW     = isL ? 285 : 201;
  const mBaseY = isL ? 223 : 210;
  const mBaseH = isL ? 114 : 74;
  let mFS = mBaseH / (nL * 1.18);
  const mFSw = (mW * 0.94) / (maxCh * 0.95);
  mFS = Math.min(mFS, mFSw, mMaxFS);
  mFS = Math.max(mFS, 8);
  const mTH = nL * mFS * 1.18;
  mkBlock({
    key:'main', text: mainRaw,
    x:  isL ? 131 : 161,
    y:  mBaseY + (mBaseH - mTH) / 2,
    w:  mW,
    fs: mFS, fw: 900, color:'#111111', align:'center', lh:1.18,
  });

  // ---- å·¥äº‹å ´æ‰€ï¼ˆä»»æ„ï¼‰ ----
  if (showLoc) {
    const z = sz === 'large' ? ZONES_LARGE : ZONES_SMALL;
    const sc = z.inner.w / ZONES_LARGE.inner.w;
    mkBlock({
      key:'loc', text: document.getElementById('f-loc').value || 'å·¥äº‹å ´æ‰€',
      x: z.main.x + 4, y: z.main.y + z.main.h + 2,
      w: z.main.w - 8,
      fs: 10 * sc, fw: 400, color:'#333333', align:'left', lh:1.0,
    });
  }

  // ---- å·¥æœŸï¼ˆæ—¥ä»˜ï¼‰ ----
  mkBlock({
    key:'pdate', text: document.getElementById('f-pdate').value,
    x:  isL ? 134 : 165,
    y:  isL ? 344 : 287,
    w:  isL ? 273 : 192,
    fs: isL ? 25  : 17,
    fw: 900, color:'#111111', align:'center', lh:1.10,
  });

  // ---- å·¥æœŸï¼ˆæ™‚é–“å¸¯ï¼‰ ----
  mkBlock({
    key:'ptime', text: 'æ™‚é–“å¸¯ã€€' + document.getElementById('f-ptime').value,
    x:  isL ? 134  : 163,
    y:  isL ? 375  : 308,
    w:  isL ? 273  : 192,
    fs: isL ? 23   : 14.5,
    fw: 900, color:'#111111', align:'center', lh:1.0,
  });

  // ---- å·¥äº‹å ----
  mkBlock({
    key:'proj', text: document.getElementById('f-proj').value,
    x:  isL ? 136  : 167,
    y:  isL ? 416  : 331,
    w:  isL ? 274  : 179,
    fs: isL ? 18   : 11.5,
    fw: 700, color:'#ffffff', align:'center', lh:1.0,
  });

  // ---- ç™ºæ³¨è€…ãƒ»æ–½å·¥è€… ----
  const inFS = isL ? 12   : 8.6;
  const inLH = 1.25;
  const lblX = isL ? 130  : 158;
  const lblW = isL ? 43   : 31;
  const valX = isL ? 183  : 195;
  const valW = isL ? 234  : 168;
  const cliY = isL ? 445  : 350;
  const conY = isL ? 496  : 385;

  mkBlock({
    key:'cli-lbl', text:'ç™ºæ³¨è€…',
    x: lblX, y: cliY, w: lblW,
    fs: inFS, fw: 900, color:'#111111', align:'left', lh:1.0,
  });
  mkBlock({
    key:'cli-val', text: document.getElementById('f-client').value,
    x: valX, y: cliY, w: valW,
    fs: inFS, fw: 900, color:'#111111', align:'left', lh: inLH,
  });
  mkBlock({
    key:'con-lbl', text:'æ–½å·¥è€…',
    x: lblX, y: conY, w: lblW,
    fs: inFS, fw: 900, color:'#111111', align:'left', lh:1.0,
  });
  mkBlock({
    key:'con-val', text: document.getElementById('f-cont').value,
    x: valX, y: conY, w: valW,
    fs: inFS, fw: 900, color:'#111111', align:'left', lh: inLH,
  });

  renderAll();
  updatePropPanel();
}

// ============================================================
//  ãƒ–ãƒ­ãƒƒã‚¯ç”Ÿæˆãƒ»æç”»
// ============================================================
function mkBlock(opts) {
  const b = {
    id: ++idCnt,
    key:    opts.key   || null,
    text:   opts.text  || '',
    x:      opts.x     || 0,
    y:      opts.y     || 0,
    w:      opts.w     || 100,
    fs:     opts.fs    || 16,
    fw:     opts.fw    || 700,
    color:  opts.color || '#111111',
    align:  opts.align || 'left',
    lh:     opts.lh    || 1.2,
    ls:     opts.ls    || 0,
  };
  blocks.push(b);
  return b;
}

function getB(id) { return blocks.find(b => b.id === id); }

function renderBlock(b) {
  let el = canvasEl.querySelector(`[data-id="${b.id}"]`);
  if (!el) {
    el = document.createElement('div');
    el.className = 'tblock';
    el.dataset.id = b.id;
    const rh = document.createElement('div');
    rh.className = 'rhandle';
    el.appendChild(rh);
    rh.addEventListener('mousedown', e => { e.stopPropagation(); startResize(e, b.id); });
    el.addEventListener('mousedown', e => { if (e.target === rh) return; startDrag(e, b.id); });
    el.addEventListener('click', e => { e.stopPropagation(); selectBlock(b.id, multiMode || e.shiftKey || e.ctrlKey); });
    canvasEl.appendChild(el);
  }

  const ob = (sz === 'large' ? ZONES_LARGE : ZONES_SMALL).outerBox;
  el.style.left          = vb2px(b.x - ob.x) + 'px';
  el.style.top           = vb2px(b.y - ob.y) + 'px';
  el.style.width         = vb2px(b.w) + 'px';
  el.style.fontSize      = vb2px(b.fs) + 'px';
  el.style.fontWeight    = b.fw;
  el.style.color         = b.color;
  el.style.textAlign     = b.align;
  el.style.lineHeight    = b.lh;
  el.style.letterSpacing = vb2px(b.ls || 0) + 'px';
  el.style.zIndex        = b.id === selectedId ? 50 : (multiSelected.includes(b.id) ? 45 : 10);
  el.classList.toggle('selected', b.id === selectedId);
  el.classList.toggle('multi-selected', multiSelected.includes(b.id) && b.id !== selectedId);

  // ãƒ†ã‚­ã‚¹ãƒˆæ›´æ–°
  const rh = el.querySelector('.rhandle');
  Array.from(el.childNodes).forEach(n => { if (n !== rh) n.remove(); });
  el.insertBefore(document.createTextNode(b.text), rh);
}

// ============================================================
//  è¤‡æ•°é¸æŠãƒ¢ãƒ¼ãƒ‰ ãƒˆã‚°ãƒ«
// ============================================================
function toggleMultiMode() {
  multiMode = !multiMode;
  const btn = document.getElementById('btnMultiMode');
  btn.classList.toggle('primary', multiMode);
  btn.textContent = multiMode ? 'â˜‘ è¤‡æ•°é¸æŠ ON' : 'â˜‘ è¤‡æ•°é¸æŠ';
  if (!multiMode) {
    // ãƒ¢ãƒ¼ãƒ‰OFFæ™‚ã«è¤‡æ•°é¸æŠã‚’è§£é™¤
    multiSelected = [];
    blocks.forEach(b => renderBlock(b));
    updatePropPanel();
  }
}

// ============================================================
//  UNDOï¼ˆå…ƒã«æˆ»ã™ï¼‰
// ============================================================
function saveHistory() {
  // blocksã®ãƒ‡ã‚£ãƒ¼ãƒ—ã‚³ãƒ”ãƒ¼ã‚’ã‚¹ã‚¿ãƒƒã‚¯ã«ç©ã‚€
  undoStack.push(JSON.stringify({ blocks, idCnt }));
  if (undoStack.length > UNDO_MAX) undoStack.shift();
  document.getElementById('btnUndo').disabled = false;
}

function undo() {
  if (undoStack.length === 0) return;
  const snapshot = JSON.parse(undoStack.pop());
  blocks = snapshot.blocks;
  idCnt  = snapshot.idCnt;
  // DOMå†æç”»
  canvasEl.querySelectorAll('.tblock').forEach(el => el.remove());
  selectedId = null;
  blocks.forEach(b => renderBlock(b));
  updatePropPanel();
  if (undoStack.length === 0) document.getElementById('btnUndo').disabled = true;
  showToast('â†© å…ƒã«æˆ»ã—ã¾ã—ãŸ');
}

// Ctrl+Z ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
document.addEventListener('keydown', e => {
  if ((e.ctrlKey || e.metaKey) && e.key === 'z') {
    e.preventDefault();
    undo();
  }
});

function renderAll() {
  canvasEl.querySelectorAll('.tblock').forEach(el => {
    if (!blocks.find(b => b.id === +el.dataset.id)) el.remove();
  });
  blocks.forEach(b => renderBlock(b));
}

// ============================================================
//  ãƒ•ã‚©ãƒ¼ãƒ æ›´æ–°
// ============================================================
function updateKey(key) {
  const z = Z();
  if (key === 'main') {
    const b = blocks.find(b => b.key === 'main');
    if (!b) return;
    const raw = document.getElementById('f-main').value;
    b.text = raw;
    // ãƒ•ã‚©ãƒ³ãƒˆå†è¨ˆç®—
    const lines = raw.split('\n').filter(l => l.trim().length > 0);
    const nL = Math.max(lines.length, 1);
    const maxCh = Math.max(...lines.map(l => l.length), 1);
    let mFS = (z.main.h * 0.92) / (nL * 1.18);
    const mFSw = (z.main.w * 0.94) / (maxCh * 0.95);
    mFS = Math.min(mFS, mFSw, z.main.w * 0.18);
    mFS = Math.max(mFS, 8);
    b.fs = mFS;
    const mTH = nL * mFS * 1.18;
    b.y = z.main.y + (z.main.h - mTH) / 2;
    renderBlock(b);
  } else if (key === 'loc') {
    const b = blocks.find(b => b.key === 'loc');
    if (b) { b.text = document.getElementById('f-loc').value; renderBlock(b); }
  } else if (key === 'pdate') {
    const b = blocks.find(b => b.key === 'pdate');
    if (b) { b.text = document.getElementById('f-pdate').value; renderBlock(b); }
  } else if (key === 'ptime') {
    const b = blocks.find(b => b.key === 'ptime');
    if (b) { b.text = 'æ™‚é–“å¸¯ã€€' + document.getElementById('f-ptime').value; renderBlock(b); }
  } else if (key === 'proj') {
    const b = blocks.find(b => b.key === 'proj');
    if (b) { b.text = document.getElementById('f-proj').value; renderBlock(b); }
  } else if (key === 'client') {
    const b = blocks.find(b => b.key === 'cli-val');
    if (b) { b.text = document.getElementById('f-client').value; renderBlock(b); reposCon(); }
  } else if (key === 'cont') {
    const b = blocks.find(b => b.key === 'con-val');
    if (b) { b.text = document.getElementById('f-cont').value; renderBlock(b); }
  }
  if (selectedId) updatePropPanel();
}

function reposCon() {
  const z = Z();
  const inFS   = z.info.h * 0.115;
  const inLH   = inFS * 1.55;
  const cliLines = document.getElementById('f-client').value.split('\n');
  const cliH   = cliLines.length * inLH;
  const cliTopY = z.info.y + z.info.h * 0.06;
  const conTopY = cliTopY + cliH + z.info.h * 0.06;
  ['con-lbl','con-val'].forEach(k => {
    const b = blocks.find(b => b.key === k);
    if (b) { b.y = conTopY; renderBlock(b); }
  });
}

// ============================================================
//  SELECT
// ============================================================
function selectBlock(id, shiftKey) {
  if (shiftKey) {
    // Shift/CtrlæŠ¼ã—ãªãŒã‚‰ã‚¯ãƒªãƒƒã‚¯ â†’ è¤‡æ•°é¸æŠã«è¿½åŠ /è§£é™¤
    if (!selectedId) {
      // ã¾ã ä½•ã‚‚é¸ã‚“ã§ã„ãªã‘ã‚Œã°æ™®é€šã«é¸æŠ
      selectedId = id;
      multiSelected = [];
    } else if (multiSelected.length === 0) {
      // å˜ç‹¬é¸æŠã‹ã‚‰2å€‹ç›®ã‚’è¿½åŠ 
      multiSelected = [selectedId, id];
      selectedId = id;
    } else if (multiSelected.includes(id)) {
      // ã™ã§ã«é¸æŠæ¸ˆã¿ãªã‚‰è§£é™¤
      multiSelected = multiSelected.filter(i => i !== id);
      if (multiSelected.length === 1) {
        selectedId = multiSelected[0];
        multiSelected = [];
      } else {
        selectedId = multiSelected[multiSelected.length - 1];
      }
    } else {
      // æ–°ãŸã«è¿½åŠ 
      multiSelected.push(id);
      selectedId = id;
    }
  } else {
    // é€šå¸¸ã‚¯ãƒªãƒƒã‚¯ â†’ å˜ç‹¬é¸æŠ
    multiSelected = [];
    selectedId = id;
  }
  blocks.forEach(b => renderBlock(b));
  updatePropPanel();
}


function updatePropPanel() {
  const empty     = document.getElementById('propEmpty');
  const ctrl      = document.getElementById('propCtrl');
  const multiCtrl = document.getElementById('multiCtrl');

  // è¤‡æ•°é¸æŠä¸­
  if (multiSelected.length >= 2) {
    empty.style.display     = 'none';
    ctrl.style.display      = 'none';
    multiCtrl.style.display = 'block';
    document.getElementById('multiCount').textContent = multiSelected.length + 'å€‹é¸æŠä¸­';
    return;
  }
  multiCtrl.style.display = 'none';

  if (!selectedId) { empty.style.display='block'; ctrl.style.display='none'; return; }
  const b = getB(selectedId);
  if (!b) { empty.style.display='block'; ctrl.style.display='none'; return; }
  empty.style.display='none'; ctrl.style.display='block';

  document.getElementById('p-text').value   = b.text;
  document.getElementById('p-fs').value     = Math.round(b.fs * 10) / 10;
  document.getElementById('p-fs-v').textContent = Math.round(b.fs * 10) / 10;
  document.getElementById('p-lh').value     = b.lh;
  document.getElementById('p-lh-v').textContent = parseFloat(b.lh).toFixed(2);
  document.getElementById('p-ls').value     = b.ls || 0;
  document.getElementById('p-ls-v').textContent = (b.ls || 0).toFixed(1);
  document.getElementById('p-x').value      = Math.round(b.x);
  document.getElementById('p-y').value      = Math.round(b.y);
  document.getElementById('p-w').value      = Math.round(b.w);

  [400,700,900].forEach(w => document.getElementById(`wb-${w}`).classList.toggle('active', b.fw == w));
  document.querySelectorAll('.csw').forEach(sw => sw.classList.toggle('active', sw.dataset.c === b.color));
  ['left','center','right'].forEach(a => document.getElementById(`ab-${a}`).classList.toggle('active', b.align === a));
}

function applyPropText() { const b=getB(selectedId); if(!b) return; saveHistory(); b.text=document.getElementById('p-text').value; renderBlock(b); }
function applyPropFS()   { const b=getB(selectedId); if(!b) return; saveHistory(); const v=parseFloat(document.getElementById('p-fs').value); b.fs=v; document.getElementById('p-fs-v').textContent=Math.round(v*10)/10; renderBlock(b); }
function applyPropLH()   { const b=getB(selectedId); if(!b) return; saveHistory(); const v=parseFloat(document.getElementById('p-lh').value); b.lh=v; document.getElementById('p-lh-v').textContent=v.toFixed(2); renderBlock(b); }
function applyPropLS()   { const b=getB(selectedId); if(!b) return; saveHistory(); const v=parseFloat(document.getElementById('p-ls').value); b.ls=v; document.getElementById('p-ls-v').textContent=v.toFixed(1); renderBlock(b); }

// ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼Â±ãƒœã‚¿ãƒ³
function stepSlider(id, delta, applyFn) {
  const el = document.getElementById(id);
  if (!el) return;
  const v = Math.round((parseFloat(el.value) + delta) * 100) / 100;
  el.value = Math.min(parseFloat(el.max), Math.max(parseFloat(el.min), v));
  applyFn();
}
// X/Y/W Â±1ãƒœã‚¿ãƒ³
function nudgePos(axis, delta) {
  const b = getB(selectedId); if (!b) return;
  if (axis === 'x') { b.x = Math.round((b.x + delta) * 2) / 2; document.getElementById('p-x').value = b.x; }
  else              { b.y = Math.round((b.y + delta) * 2) / 2; document.getElementById('p-y').value = b.y; }
  renderBlock(b);
}
function nudgeW(delta) {
  const b = getB(selectedId); if (!b) return;
  b.w = Math.max(10, Math.round((b.w + delta) * 2) / 2);
  document.getElementById('p-w').value = b.w;
  renderBlock(b);
}
function applyWeight(w)  { const b=getB(selectedId); if(!b) return; saveHistory(); b.fw=w; [400,700,900].forEach(ww=>document.getElementById(`wb-${ww}`).classList.toggle('active',ww==w)); renderBlock(b); }
function applyColor(el)  { const b=getB(selectedId); if(!b) return; saveHistory(); b.color=el.dataset.c; document.querySelectorAll('.csw').forEach(sw=>sw.classList.toggle('active',sw.dataset.c===b.color)); renderBlock(b); }
function applyColorHex(h){ const b=getB(selectedId); if(!b) return; saveHistory(); b.color=h; document.querySelectorAll('.csw').forEach(sw=>sw.classList.remove('active')); renderBlock(b); }
function applyAlign(a)   { const b=getB(selectedId); if(!b) return; saveHistory(); b.align=a; ['left','center','right'].forEach(aa=>document.getElementById(`ab-${aa}`).classList.toggle('active',aa===a)); renderBlock(b); }
function applyPropPos()  { const b=getB(selectedId); if(!b) return; saveHistory(); b.x=parseFloat(document.getElementById('p-x').value)||0; b.y=parseFloat(document.getElementById('p-y').value)||0; renderBlock(b); }
function applyPropW()    { const b=getB(selectedId); if(!b) return; saveHistory(); b.w=parseFloat(document.getElementById('p-w').value)||50; renderBlock(b); }

// ============================================================
//  DRAG
// ============================================================
function startDrag(e, id) {
  // ã‚¹ãƒšãƒ¼ã‚¹ãƒ‘ãƒ³ä¸­ã¯ãƒ†ã‚­ã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹ã®ãƒ‰ãƒ©ãƒƒã‚°ã‚’ç„¡è¦–
  if (spaceDown) return;
  e.preventDefault();
  // Shift/Ctrlã‚­ãƒ¼ â†’ é¸æŠã‚’è¿½åŠ 
  if (e.shiftKey || e.ctrlKey) {
    selectBlock(id, true);
  }
  // ã™ã§ã«è¤‡æ•°é¸æŠä¸­ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹ â†’ é¸æŠã‚’å´©ã•ãªã„
  // å˜ç‹¬é¸æŠä¸­ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’ãƒ‰ãƒ©ãƒƒã‚° â†’ ãã®ã¾ã¾å˜ç‹¬é¸æŠ
  // â€» clickã‚¤ãƒ™ãƒ³ãƒˆã§å˜ç‹¬é¸æŠã¸ã®å¤‰æ›´ã¯è¡Œã†ãŒã€mousedownã§ã¯å´©ã•ãªã„
  if (multiSelected.length < 2 && !multiSelected.includes(id)) {
    // è¤‡æ•°é¸æŠå¤–ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’å˜ç‹¬ãƒ‰ãƒ©ãƒƒã‚° â†’ å˜ç‹¬é¸æŠã«
    selectedId = id;
    multiSelected = [];
    blocks.forEach(b => renderBlock(b));
    updatePropPanel();
  }
  const b = getB(id);
  saveHistory();
  const multiSnap = multiSelected.length >= 2
    ? multiSelected.map(mid => { const mb = getB(mid); return { id: mid, bx: mb.x, by: mb.y }; })
    : null;
  dragState = { id, sx:e.clientX, sy:e.clientY, bx:b.x, by:b.y, multiSnap };
}

document.addEventListener('mousemove', e => {
  if (dragState) {
    const dx = px2vb(e.clientX - dragState.sx);
    const dy = px2vb(e.clientY - dragState.sy);
    if (dragState.multiSnap) {
      // è¤‡æ•°é¸æŠ: å…¨ãƒ–ãƒ­ãƒƒã‚¯ç§»å‹•
      dragState.multiSnap.forEach(snap => {
        const mb = getB(snap.id);
        if (mb) { mb.x = Math.round((snap.bx + dx) * 2) / 2; mb.y = Math.round((snap.by + dy) * 2) / 2; renderBlock(mb); }
      });
    } else {
      const b = getB(dragState.id);
      b.x = Math.round((dragState.bx + dx) * 2) / 2;
      b.y = Math.round((dragState.by + dy) * 2) / 2;
      renderBlock(b);
    }
    updatePropPanel();
    const tt = document.getElementById('posTT');
    const ob2 = (sz==='large'?ZONES_LARGE:ZONES_SMALL).outerBox;
    tt.style.display='block';
    tt.style.left = (vb2px(b.x - ob2.x) + vb2px(b.w) + 4) + 'px';
    tt.style.top  = vb2px(b.y - ob2.y) + 'px';
    tt.textContent = `X:${Math.round(b.x)} Y:${Math.round(b.y)}`;
    return;
  }
  if (resizeState) {
    const dx = px2vb(e.clientX - resizeState.sx);
    const b  = getB(resizeState.id);
    b.w = Math.max(20, resizeState.sw + dx);
    renderBlock(b); updatePropPanel();
  }
});

document.addEventListener('mouseup', () => {
  dragState = resizeState = null;
  document.getElementById('posTT').style.display = 'none';
});

// ============================================================
//  RESIZE
// ============================================================
function startResize(e, id) {
  e.preventDefault();
  saveHistory(); // ãƒªã‚µã‚¤ã‚ºé–‹å§‹å‰ã«ä¿å­˜
  const b = getB(id);
  resizeState = { id, sx:e.clientX, sw:b.w };
}

// ============================================================
//  ADD FREE BLOCK
// ============================================================
function addFreeBlock() {
  saveHistory();
  const z = Z();
  const b = mkBlock({
    text:'æ–°ã—ã„ãƒ†ã‚­ã‚¹ãƒˆ',
    x: z.inner.x + 10, y: z.inner.y + 10,
    w: z.inner.w * 0.6,
    fs: z.inner.w * 0.04, fw:700, color:'#111111',
  });
  renderBlock(b);
  selectBlock(b.id);
}

function deleteSelected() {
  if (!selectedId) return;
  saveHistory();
  blocks = blocks.filter(b => b.id !== selectedId);
  canvasEl.querySelector(`[data-id="${selectedId}"]`)?.remove();
  selectedId = null;
  updatePropPanel();
}

// ============================================================
//  è¤‡æ•°é¸æŠ æ•´åˆ—
// ============================================================
function alignBlocks(type) {
  if (multiSelected.length < 2) return;
  saveHistory();
  const bs = multiSelected.map(id => getB(id)).filter(Boolean);
  const xs  = bs.map(b => b.x);
  const ys  = bs.map(b => b.y);
  const x2s = bs.map(b => b.x + b.w);
  const y2s = bs.map(b => b.y + b.fs * (parseFloat(b.lh)||1.2) * b.text.split('\n').length);
  const minX = Math.min(...xs), maxX2 = Math.max(...x2s);
  const minY = Math.min(...ys), maxY2 = Math.max(...y2s);
  const cx = (minX + maxX2) / 2, cy = (minY + maxY2) / 2;
  bs.forEach(b => {
    const bH = b.fs * (parseFloat(b.lh)||1.2) * b.text.split('\n').length;
    if      (type === 'left')    b.x = minX;
    else if (type === 'right')   b.x = maxX2 - b.w;
    else if (type === 'centerX') b.x = cx - b.w / 2;
    else if (type === 'top')     b.y = minY;
    else if (type === 'bottom')  b.y = maxY2 - bH;
    else if (type === 'centerY') b.y = cy - bH / 2;
    renderBlock(b);
  });
  showToast('âœ… æ•´åˆ—ã—ã¾ã—ãŸ');
}

// ============================================================
//  HEADER / LOC / SIZE
// ============================================================
function setHeader(t) {
  document.getElementById('hb-mei').classList.toggle('active', t==='meiwaku');
  document.getElementById('hb-kyo').classList.toggle('active', t==='kyoryoku');
  const b = blocks.find(b => b.key === 'header');
  if (b) { b.text = t==='meiwaku' ? 'ã”è¿·æƒ‘ã‚’ãŠã‹ã‘ã—ã¾ã™' : 'ã”å”åŠ›ã‚’ãŠé¡˜ã„ã—ã¾ã™'; renderBlock(b); }
}

function toggleLoc() {
  showLoc = !showLoc;
  document.getElementById('locTog').classList.toggle('on', showLoc);
  document.getElementById('locField').style.display = showLoc ? 'block' : 'none';
  resetLayout();
}

function setSize(s) {
  sz = s;
  document.getElementById('sz-large').classList.toggle('active', s==='large');
  document.getElementById('sz-small').classList.toggle('active', s==='small');
  resetLayout();
}

function resetLayout() {
  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä¿å­˜ãŒã‚ã‚Œã°ãã‚Œã‚’å¾©å…ƒã€ãªã‘ã‚Œã°é€šå¸¸ã®åˆæœŸå€¤
  const saved = loadDefault(sz);
  if (saved && saved.blocks && saved.blocks.length > 0) {
    // ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’é©ç”¨ï¼ˆã‚µã‚¤ã‚ºã¯ç¾åœ¨ã®szã‚’ç¶­æŒï¼‰
    saved.sz = sz;
    applyState(saved);
    showToast(`â­ ${sz === 'large' ? 'å¤§' : 'å°'}ã‚µã‚¤ã‚ºã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
    return;
  }
  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä¿å­˜ãªã— â†’ é€šå¸¸ã®åˆæœŸå€¤
  const def = getDefaults();
  document.getElementById('f-main').value   = def.main;
  document.getElementById('f-pdate').value  = def.pdate;
  document.getElementById('f-ptime').value  = def.ptime;
  document.getElementById('f-proj').value   = def.proj;
  document.getElementById('f-client').value = def.client;
  document.getElementById('f-cont').value   = def.cont;
  document.getElementById('hb-mei').classList.toggle('active', def.headerType === 'meiwaku');
  document.getElementById('hb-kyo').classList.toggle('active', def.headerType === 'kyoryoku');
  setupCanvas();
  buildTemplate();
}

// ============================================================
//  SVG EXPORTï¼ˆã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³åŒ–ç‰ˆï¼‰
//  opentype.js ã‚’ä½¿ã£ã¦ãƒ†ã‚­ã‚¹ãƒˆã‚’ã™ã¹ã¦SVGãƒ‘ã‚¹ã«å¤‰æ›ã€‚
//  ãƒ•ã‚©ãƒ³ãƒˆä¾å­˜ã‚¼ãƒ­ãƒ»Illustratorã§å®Œå…¨ä¸€è‡´ãƒ»æ‹¡å¤§ã—ã¦ã‚‚è’ã‚Œãªã„ã€‚
// ============================================================

// ãƒ•ã‚©ãƒ³ãƒˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆé‡é‡ç´šãªã®ã§ä¸€åº¦ã ã‘èª­ã¿è¾¼ã‚€ï¼‰
const _fontCache = {};

// Google Fonts Early Access ã® OTFï¼ˆ1ãƒ•ã‚¡ã‚¤ãƒ«ã§å…¨æ—¥æœ¬èªæ–‡å­—å¯¾å¿œï¼‰
// â€» opentype.js ã¯ woff2 æœªå¯¾å¿œã®ãŸã‚ OTF ã‚’ä½¿ç”¨
async function loadOpentypeFont(weight) {
  if (_fontCache[weight]) return _fontCache[weight];

  const nearestW = [400, 700, 900].reduce((a, b) =>
    Math.abs(b - weight) < Math.abs(a - weight) ? b : a
  );
  if (_fontCache[nearestW]) {
    _fontCache[weight] = _fontCache[nearestW];
    return _fontCache[nearestW];
  }

  // Google Fonts Early Access ã® OTFï¼ˆéåˆ†å‰²ãƒ»å…¨æ–‡å­—åéŒ²ï¼‰
  const FONT_URLS = {
    400: 'https://fonts.gstatic.com/ea/notosansjapanese/v6/NotoSansJP-Regular.otf',
    700: 'https://fonts.gstatic.com/ea/notosansjapanese/v6/NotoSansJP-Bold.otf',
    900: 'https://fonts.gstatic.com/ea/notosansjapanese/v6/NotoSansJP-Black.otf',
  };

  const url = FONT_URLS[nearestW];
  showToast(`ğŸ”¤ ãƒ•ã‚©ãƒ³ãƒˆèª­ã¿è¾¼ã¿ä¸­â€¦ åˆå›ã®ã¿å°‘ã—æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™`, 12000);

  const resp = await fetch(url);
  if (!resp.ok) throw new Error(`ãƒ•ã‚©ãƒ³ãƒˆå–å¾—å¤±æ•— (${resp.status}): ${url}`);
  const buf  = await resp.arrayBuffer();
  const font = opentype.parse(buf);
  _fontCache[weight]   = font;
  _fontCache[nearestW] = font;
  return font;
}

// ãƒ†ã‚­ã‚¹ãƒˆ1è¡Œ â†’ SVGãƒ‘ã‚¹æ–‡å­—åˆ—
// opentype.js ã® getPath ã¯ (x, y, fontSize) ã§
// y = ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ã€SVGåº§æ¨™ç³»ï¼ˆYè»¸ä¸‹å‘ãï¼‰ã§æ­£ã—ãå‹•ä½œã™ã‚‹
function textToPathData(font, text, fontSize, align, boxX, boxY, boxW, letterSpacing, svgOffsetEm) {
  if (!text || text.trim() === '') return '';

  const upem  = font.unitsPerEm;
  const sc    = fontSize / upem;
  const ls    = letterSpacing || 0;

  let totalAdv = 0;
  for (let i = 0; i < text.length; i++) {
    const g = font.charToGlyph(text[i]);
    totalAdv += ((g && g.advanceWidth) ? g.advanceWidth : upem * 0.6) * sc + ls;
  }
  if (text.length > 0) totalAdv -= ls;

  let drawX;
  if (align === 'center')     drawX = boxX + (boxW - totalAdv) / 2;
  else if (align === 'right') drawX = boxX + boxW - totalAdv;
  else                        drawX = boxX;

  // ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³è¨ˆç®— + ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼è£œæ­£
  const ascent     = font.ascender * sc;
  const descender  = Math.abs(font.descender * sc);
  const totalLineH = ascent + descender;
  const offsetPx   = (svgOffsetEm || 0) * sc;
  const baselineY  = boxY + ascent - (totalLineH - fontSize) / 2 + offsetPx;

  let pathData = '';
  let curX = drawX;

  for (let i = 0; i < text.length; i++) {
    const ch    = text[i];
    const glyph = font.charToGlyph(ch);
    if (!glyph) continue;
    const glyphPath = glyph.getPath(curX, baselineY, fontSize);
    const d = glyphPath.toPathData(3);
    if (d && d.trim() !== '') pathData += `<path d="${d}"/>`;
    const adv = (glyph.advanceWidth ? glyph.advanceWidth : upem * 0.6) * sc;
    curX += adv + ls;
  }
  return pathData;
}

async function exportSVG() {
  if (typeof opentype === 'undefined') {
    showToast('âš ï¸ opentypeãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒèª­ã¿è¾¼ã‚ã¦ã„ã¾ã›ã‚“', 3000);
    return;
  }

  const weights = [...new Set(blocks.map(b => b.fw))];
  try {
    await Promise.all(weights.map(w => loadOpentypeFont(w)));
  } catch(e) {
    showToast('âš ï¸ ãƒ•ã‚©ãƒ³ãƒˆèª­ã¿è¾¼ã¿å¤±æ•—: ' + e.message, 4000);
    return;
  }

  // èƒŒæ™¯SVGã‚’è§£ä½“
  const bgRaw = (sz === 'large' ? SVG_LARGE : SVG_SMALL)
    .replace(/<\?xml[^>]*\?>\s*/i, '')
    .replace(/<svg[^>]*>/i, '')
    .replace(/<\/svg>/i, '');
  const bgDefsMatch = bgRaw.match(/<defs>([\s\S]*?)<\/defs>/i);
  const bgDefs   = bgDefsMatch ? bgDefsMatch[1] : '';
  const bgShapes = bgRaw.replace(/<defs>[\s\S]*?<\/defs>/i, '').trim();

  // ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³è£œæ­£ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼å€¤
  const svgOffsetEm = parseFloat(document.getElementById('svgOffsetSlider')?.value ?? '-0.5');

  // å„ãƒ–ãƒ­ãƒƒã‚¯ã‚’ãƒ‘ã‚¹ã«å¤‰æ›
  let txtSVG = '';
  for (let idx = 0; idx < blocks.length; idx++) {
    const b    = blocks[idx];
    const font = _fontCache[b.fw] || _fontCache[Object.keys(_fontCache)[0]];
    if (!font) continue;

    const lines = b.text.split('\n');
    const lh    = b.fs * (parseFloat(b.lh) || 1.2);
    const ls    = b.ls || 0;
    const keyLabel = b.key ? `block_${b.key}` : `block_${idx}`;
    txtSVG += `\n  <g id="${keyLabel}" fill="${b.color}">`;

    lines.forEach((line, i) => {
      if (!line) return;
      const lineTopY = b.y + i * lh;
      const paths = textToPathData(font, line, b.fs, b.align, b.x, lineTopY, b.w, ls, svgOffsetEm);
      txtSVG += paths;
    });
    txtSVG += `\n  </g>`;
  }

  // outerBoxã§viewBoxã‚’ã‚¯ãƒ­ãƒƒãƒ— â†’ ã‚¢ãƒ¼ãƒˆãƒœãƒ¼ãƒ‰=çœ‹æ¿ã‚µã‚¤ã‚º
  const z  = sz === 'large' ? ZONES_LARGE : ZONES_SMALL;
  const ob = z.outerBox;
  const signPhysical = sz === 'large' ? { w:1100, h:1400 } : { w:800, h:900 };

  const svgContent = `<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg
  xmlns="http://www.w3.org/2000/svg"
  version="1.1"
  viewBox="${ob.x} ${ob.y} ${ob.w} ${ob.h}"
  width="${signPhysical.w}mm"
  height="${signPhysical.h}mm">
  <!--
    å·¥äº‹æ¨™ç¤ºæ¿ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ„ãƒ¼ãƒ« SVGå‡ºåŠ›ï¼ˆã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³åŒ–æ¸ˆã¿ï¼‰
    ã‚µã‚¤ã‚º: ${signPhysical.w}Ã—${signPhysical.h}mm
  -->
  <defs>${bgDefs}</defs>
  <rect x="${ob.x}" y="${ob.y}" width="${ob.w}" height="${ob.h}" fill="#ffffff"/>
  <g id="background_graphic">${bgShapes}</g>
  <g id="text_layer">${txtSVG}</g>
</svg>`;

  // ãƒ•ã‚¡ã‚¤ãƒ«åç”Ÿæˆï¼ˆæ—¥ä»˜ï¼‹æ–½å·¥è€…åã‹ã‚‰å† é™¤å»ï¼‰
  function makeBaseName() {
    const t = new Date();
    const date = `${t.getFullYear()}${String(t.getMonth()+1).padStart(2,'0')}${String(t.getDate()).padStart(2,'0')}`;
    const raw = document.getElementById('f-cont').value.split('\n')[0] || '';
    const name = raw
      .replace(/^(æ ªå¼ä¼šç¤¾|æœ‰é™ä¼šç¤¾|åˆåŒä¼šç¤¾|ä¸€èˆ¬ç¤¾å›£æ³•äºº|å…¬ç›Šç¤¾å›£æ³•äºº|åŒ»ç™‚æ³•äºº|ç¤¾ä¼šç¦ç¥‰æ³•äºº|å­¦æ ¡æ³•äºº)\s*/g, '')
      .replace(/\s*(æ ªå¼ä¼šç¤¾|æœ‰é™ä¼šç¤¾|åˆåŒä¼šç¤¾|ï¼ˆæ ªï¼‰|\(æ ª\)|ãˆ±)$/g, '')
      .trim().replace(/[\s\/\\:*?"<>|]/g, '_').slice(0, 20);
    return `${date}${name}å·¥äº‹æ¨™ç¤ºæ¿`;
  }

  const baseName = makeBaseName();
  const svgBlob  = new Blob([svgContent], { type:'image/svg+xml;charset=utf-8' });

  // SVG â†’ Canvas â†’ PNGç”Ÿæˆ
  async function renderToPngBlob() {
    const url = URL.createObjectURL(svgBlob);
    return new Promise((resolve, reject) => {
      const img = new Image();
      img.onload = () => {
        const W = 1800, H = Math.round(W * ob.h / ob.w);
        const cv = document.createElement('canvas');
        cv.width = W; cv.height = H;
        const ctx = cv.getContext('2d');
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, W, H);
        ctx.drawImage(img, 0, 0, W, H);
        URL.revokeObjectURL(url);
        cv.toBlob(b => b ? resolve(b) : reject(new Error('toBlobå¤±æ•—')), 'image/png');
      };
      img.onerror = () => { URL.revokeObjectURL(url); reject(new Error('ç”»åƒèª­è¾¼å¤±æ•—')); };
      img.src = url;
    });
  }

  showToast('ğŸ–¼ï¸ ç”»åƒã‚’ç”Ÿæˆä¸­â€¦', 4000);
  let pngBlob;
  try { pngBlob = await renderToPngBlob(); }
  catch(e) { showToast('âš ï¸ PNGç”Ÿæˆå¤±æ•—: ' + e.message, 4000); return; }

  // ãƒ•ã‚©ãƒ«ãƒ€é¸æŠã—ã¦ä¿å­˜ï¼ˆChrome/Edgeï¼‰/ é€šå¸¸DLã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
  if (window.showDirectoryPicker) {
    try {
      showToast('ğŸ“ ä¿å­˜å…ˆãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸ã‚“ã§ãã ã•ã„', 5000);
      const dir = await window.showDirectoryPicker({ mode:'readwrite' });

      const svgFile = await dir.getFileHandle(`${baseName}.svg`, { create:true });
      const svgW = await svgFile.createWritable();
      await svgW.write(svgBlob); await svgW.close();

      const pngFile = await dir.getFileHandle(`${baseName}_ç¢ºèªç”¨.png`, { create:true });
      const pngW = await pngFile.createWritable();
      await pngW.write(pngBlob); await pngW.close();

      showToast(`âœ… ä¿å­˜å®Œäº†ï¼ ${baseName}`);
    } catch(e) {
      if (e.name === 'AbortError') showToast('âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ');
      else showToast('âš ï¸ ä¿å­˜å¤±æ•—: ' + e.message, 4000);
    }
  } else {
    // Firefox/Safari ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    showToast('ğŸ“¥ ãƒ•ã‚©ãƒ«ãƒ€é¸æŠéå¯¾å¿œã®ãŸã‚é€šå¸¸ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™', 3000);
    const a1 = document.createElement('a');
    a1.href = URL.createObjectURL(svgBlob);
    a1.download = `${baseName}.svg`; a1.click();
    setTimeout(() => {
      const a2 = document.createElement('a');
      a2.href = URL.createObjectURL(pngBlob);
      a2.download = `${baseName}_ç¢ºèªç”¨.png`; a2.click();
      showToast(`âœ… 2ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ`);
    }, 600);
  }
}

// ============================================================
//  ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«
// ============================================================
const LS_DEFAULTS_KEY = 'koji-sign-defaults';

// ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼ˆãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰åˆæœŸå€¤ï¼‰
const HARDCODED_DEFAULTS = {
  headerType: 'meiwaku',
  main:   'å£Šã‚ŒãŸè­·å²¸ã‚’\nç›´ã—ã¦ã„ã¾ã™ã€‚',
  pdate:  'ä»¤å’Œï¼—å¹´ï¼’æœˆ28æ—¥ã¾ã§',
  ptime:  '8:00 ï½ 17:00',
  proj:   'èŠ±æœˆå·ä¸‰å’Œåœ°åŒºå¤–ç½å®³å¾©æ—§å·¥äº‹',
  client: 'å›½åœŸäº¤é€šçœã€€ä¹å·åœ°æ–¹æ•´å‚™å±€\nç­‘å¾Œå·æ²³å·äº‹å‹™æ‰€ã€€æ—¥ç”°å‡ºå¼µæ‰€\né›»è©±ã€€0972ï¼23ï¼5291',
  cont:   'ç”°ä¸­å»ºè¨­æ ªå¼ä¼šç¤¾\né›»è©±ã€€0973ï¼23ï¼8185\nç¾å ´ä»£ç†äººã€€å±±æœ¬ã€€äº®ä¸€',
};

// ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’å–å¾—ï¼ˆãªã‘ã‚Œã°ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰å€¤ï¼‰
function getDefaults() {
  try {
    const raw = localStorage.getItem(LS_DEFAULTS_KEY);
    if (raw) return { ...HARDCODED_DEFAULTS, ...JSON.parse(raw) };
  } catch(e) {}
  return { ...HARDCODED_DEFAULTS };
}

// è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
function openSettings() {
  const def = getDefaults();
  // ãƒ•ã‚©ãƒ¼ãƒ ã«ç¾åœ¨ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ã‚»ãƒƒãƒˆ
  document.getElementById('def-main').value   = def.main;
  document.getElementById('def-pdate').value  = def.pdate;
  document.getElementById('def-ptime').value  = def.ptime;
  document.getElementById('def-proj').value   = def.proj;
  document.getElementById('def-client').value = def.client;
  document.getElementById('def-cont').value   = def.cont;
  document.getElementById('def-hb-mei').classList.toggle('active', def.headerType === 'meiwaku');
  document.getElementById('def-hb-kyo').classList.toggle('active', def.headerType === 'kyoryoku');

  const overlay = document.getElementById('settingsOverlay');
  overlay.style.display = 'flex';
}

// è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
function closeSettings() {
  document.getElementById('settingsOverlay').style.display = 'none';
}

// è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®ãƒ˜ãƒƒãƒ€ãƒ¼é¸æŠ
function setDefHeader(t) {
  document.getElementById('def-hb-mei').classList.toggle('active', t === 'meiwaku');
  document.getElementById('def-hb-kyo').classList.toggle('active', t === 'kyoryoku');
}

// ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ä¿å­˜
function saveDefaultSettings() {
  const headerType = document.getElementById('def-hb-mei').classList.contains('active') ? 'meiwaku' : 'kyoryoku';
  const newDefaults = {
    headerType,
    main:   document.getElementById('def-main').value,
    pdate:  document.getElementById('def-pdate').value,
    ptime:  document.getElementById('def-ptime').value,
    proj:   document.getElementById('def-proj').value,
    client: document.getElementById('def-client').value,
    cont:   document.getElementById('def-cont').value,
  };
  try {
    localStorage.setItem(LS_DEFAULTS_KEY, JSON.stringify(newDefaults));
    showToast('âœ… ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
    closeSettings();
  } catch(e) {
    showToast('âš ï¸ ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
  }
}

// ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
document.getElementById('settingsOverlay').addEventListener('click', e => {
  if (e.target === document.getElementById('settingsOverlay')) closeSettings();
});
window.addEventListener('resize', () => { setupCanvas(); renderAll(); applyTransform(); });
window.addEventListener('DOMContentLoaded', () => {
  // èµ·å‹•æ™‚ã®èª­ã¿è¾¼ã¿å„ªå…ˆé †ä½ï¼š
  // 1. ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä¿å­˜ãŒã‚ã‚‹ â†’ è‡ªå‹•ã§èª­ã¿è¾¼ã‚€
  // 2. å‰å›ã®ä½œæ¥­ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹ â†’ å¾©å…ƒ
  // 3. ã©ã¡ã‚‰ã‚‚ãªã— â†’ åˆæœŸå€¤
  const savedDefault = loadDefault(sz);
  if (savedDefault && savedDefault.blocks && savedDefault.blocks.length > 0) {
    savedDefault.sz = sz;
    applyState(savedDefault);
    // é™ã‹ã«èª­ã¿è¾¼ã‚€ï¼ˆãƒˆãƒ¼ã‚¹ãƒˆãªã—ï¼‰
  } else if (!loadFromLocal()) {
    resetLayout();
  }
  // è‡ªå‹•ä¿å­˜ï¼ˆ30ç§’ã”ã¨ï¼‰
  setInterval(autoSave, 30000);
  // canvasAreaèƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é¸æŠè§£é™¤
  document.getElementById('canvasArea').addEventListener('click', e => {
    if (e.target === document.getElementById('canvasArea') ||
        e.target === document.getElementById('canvasWrapper') ||
        e.target === document.getElementById('signCanvas')) {
      selectedId = null;
      multiSelected = [];
      blocks.forEach(b => renderBlock(b));
      updatePropPanel();
    }
  });
});

// ============================================================
//  TOAST é€šçŸ¥
// ============================================================
function showToast(msg, duration=2000) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), duration);
}

// ============================================================
//  çŠ¶æ…‹ã‚’ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«åé›†
// ============================================================
function collectState() {
  return {
    version: 1,
    sz,
    showLoc,
    headerType: document.getElementById('hb-mei').classList.contains('active') ? 'meiwaku' : 'kyoryoku',
    forms: {
      main:   document.getElementById('f-main').value,
      loc:    document.getElementById('f-loc').value,
      pdate:  document.getElementById('f-pdate').value,
      ptime:  document.getElementById('f-ptime').value,
      proj:   document.getElementById('f-proj').value,
      client: document.getElementById('f-client').value,
      cont:   document.getElementById('f-cont').value,
    },
    blocks: blocks.map(b => ({ ...b })),
    idCnt,
  };
}

// ============================================================
//  çŠ¶æ…‹ã‚’å¾©å…ƒ
// ============================================================
function applyState(state) {
  if (!state || state.version !== 1) return false;

  sz      = state.sz      || 'large';
  showLoc = state.showLoc || false;
  idCnt   = state.idCnt   || 0;

  // ã‚µã‚¤ã‚ºãƒœã‚¿ãƒ³
  document.getElementById('sz-large').classList.toggle('active', sz === 'large');
  document.getElementById('sz-small').classList.toggle('active', sz === 'small');

  // ãƒ˜ãƒƒãƒ€ãƒ¼
  const ht = state.headerType || 'meiwaku';
  document.getElementById('hb-mei').classList.toggle('active', ht === 'meiwaku');
  document.getElementById('hb-kyo').classList.toggle('active', ht === 'kyoryoku');

  // å·¥äº‹å ´æ‰€ãƒˆã‚°ãƒ«
  document.getElementById('locTog').classList.toggle('on', showLoc);
  document.getElementById('locField').style.display = showLoc ? 'block' : 'none';

  // ãƒ•ã‚©ãƒ¼ãƒ å€¤
  if (state.forms) {
    document.getElementById('f-main').value   = state.forms.main   || '';
    document.getElementById('f-loc').value    = state.forms.loc    || '';
    document.getElementById('f-pdate').value  = state.forms.pdate  || '';
    document.getElementById('f-ptime').value  = state.forms.ptime  || '';
    document.getElementById('f-proj').value   = state.forms.proj   || '';
    document.getElementById('f-client').value = state.forms.client || '';
    document.getElementById('f-cont').value   = state.forms.cont   || '';
  }

  // ãƒ–ãƒ­ãƒƒã‚¯å¾©å…ƒ
  blocks = state.blocks || [];

  // ã‚­ãƒ£ãƒ³ãƒã‚¹å†æ§‹ç¯‰
  setupCanvas();
  renderAll();
  updatePropPanel();

  return true;
}

// ============================================================
//  â‘  ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜
// ============================================================
const LS_KEY         = 'koji-sign-state';
const LS_DEFAULT_LARGE = 'koji-default-large'; // å¤§ã‚µã‚¤ã‚ºã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
const LS_DEFAULT_SMALL = 'koji-default-small'; // å°ã‚µã‚¤ã‚ºã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ

// ç¾åœ¨ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¨ã—ã¦ä¿å­˜
function saveAsDefault() {
  try {
    const key = sz === 'large' ? LS_DEFAULT_LARGE : LS_DEFAULT_SMALL;
    const state = collectState();
    localStorage.setItem(key, JSON.stringify(state));
    showToast(`â­ ${sz === 'large' ? 'å¤§' : 'å°'}ã‚µã‚¤ã‚ºã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’ä¿å­˜ã—ã¾ã—ãŸï¼`);
  } catch(e) {
    showToast('âš ï¸ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
  }
}

// ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’èª­ã¿è¾¼ã‚€ï¼ˆãªã‘ã‚Œã°falseï¼‰
function loadDefault(sizeName) {
  try {
    const key = sizeName === 'large' ? LS_DEFAULT_LARGE : LS_DEFAULT_SMALL;
    const raw = localStorage.getItem(key);
    if (!raw) return false;
    return JSON.parse(raw);
  } catch(e) {
    return false;
  }
}

function saveToLocal() {
  try {
    localStorage.setItem(LS_KEY, JSON.stringify(collectState()));
    showToast('ğŸ’¾ ä¿å­˜ã—ã¾ã—ãŸ');
    // ä¿å­˜ãƒœã‚¿ãƒ³ã«ä¸€æ™‚çš„ã«ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
    const btn = document.getElementById('btnSave');
    btn.textContent = 'âœ… ä¿å­˜æ¸ˆã¿';
    setTimeout(() => { btn.textContent = 'ğŸ’¾ ä¿å­˜'; }, 2000);
  } catch(e) {
    showToast('âš ï¸ ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
  }
}

function loadFromLocal() {
  try {
    const raw = localStorage.getItem(LS_KEY);
    if (!raw) return false;
    const state = JSON.parse(raw);
    const ok = applyState(state);
    if (ok) showToast('ğŸ“‚ å‰å›ã®ä½œæ¥­ã‚’å¾©å…ƒã—ã¾ã—ãŸ');
    return ok;
  } catch(e) {
    return false;
  }
}

function autoSave() {
  try {
    localStorage.setItem(LS_KEY, JSON.stringify(collectState()));
    // é™ã‹ã«è‡ªå‹•ä¿å­˜ï¼ˆãƒˆãƒ¼ã‚¹ãƒˆä¸è¦ï¼‰
  } catch(e) {}
}

// ============================================================
//  â‘¡ JSON ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ / ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
// ============================================================
function exportJSON() {
  const state = collectState();
  const json  = JSON.stringify(state, null, 2);
  const blob  = new Blob([json], { type: 'application/json;charset=utf-8' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  // ãƒ•ã‚¡ã‚¤ãƒ«åã«å·¥äº‹åãƒ»æ—¥ä»˜ã‚’å«ã‚ã‚‹
  const proj = document.getElementById('f-proj').value.replace(/[\s\/\\:*?"<>|]/g, '_').slice(0, 20);
  const date = new Date().toISOString().slice(0,10);
  a.download = `çœ‹æ¿_${proj}_${date}.json`;
  a.click();
  showToast('ğŸ“¤ JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
}

function importJSON(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const state = JSON.parse(e.target.result);
      const ok = applyState(state);
      if (ok) {
        showToast('âœ… ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
        // ãƒ­ãƒ¼ã‚«ãƒ«ã«ã‚‚ä¿å­˜
        localStorage.setItem(LS_KEY, JSON.stringify(state));
      } else {
        showToast('âš ï¸ ãƒ•ã‚¡ã‚¤ãƒ«ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
      }
    } catch(err) {
      showToast('âš ï¸ èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
    // inputã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆåŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†åº¦èª­ã‚ã‚‹ï¼‰
    event.target.value = '';
  };
  reader.readAsText(file);
}
</script>
</body>
</html>
